<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lite Football</title>
    <!-- 
      A single, lightweight HTML file for old browsers.
      All CSS and JS are inline.
      By Gemini
    -->
    <style>
        /* --- Global Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Default (Dark Blue) Theme variables */
        :root {
            --bg-body: #0a192f;
            --bg-panel: #1c2b4a;
            --bg-element: #30416b;
            --text-primary: #e0e0e0;
            --text-secondary: #a0b0d0;
            --border-color: #30416b;
            --accent-color: #64ffda;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-size: 16px; /* Base font size for TV */
            transition: background-color 0.3s, color 0.3s;
        }
        
        #app-wrapper {
            max-width: 1400px; /* Max width for wide TVs */
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #content-container {
            flex-grow: 1;
        }

        a {
            color: var(--accent-color);
            text-decoration: none;
        }

        img {
            max-width: 100%;
            height: auto;
        }

        /* --- API Key Modal --- */
        #user-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #user-modal.visible {
            display: flex;
        }

        .modal-content {
            background: var(--bg-panel);
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        .modal-content h2 {
            margin-bottom: 1rem;
        }

        .modal-content p {
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .modal-content input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-body);
            color: var(--text-primary);
            font-size: 1rem;
        }

        /* --- Header --- */
        #app-header {
            background: var(--bg-panel);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* For small screens */
            gap: 0.5rem;
        }

        #app-header h1 {
            font-size: 1.5rem;
            flex-basis: 100%; /* Full width on small screens */
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .date-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-nav button,
        #user-submit,
        .styled-button { /* NEW: Reusable button class */
            background: var(--bg-element);
            color: var(--text-primary);
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
        }

        #current-date {
            font-size: 1.1rem;
            font-weight: bold;
            min-width: 100px;
            text-align: center;
        }

        .live-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }
        
        /* NEW: Header Username */
        .header-username {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-secondary);
            flex-basis: 100%;
            text-align: right;
            order: -1; /* Move to top on mobile */
            padding: 0 0.5rem;
        }

        @media (min-width: 768px) {
            .header-username {
                flex-basis: auto;
                order: 0; /* Reset order */
                text-align: left;
            }
            #app-header h1 {
                flex-basis: auto;
                order: 0;
            }
        }
        
        .switch-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-element);
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-color);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--accent-color);
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(22px);
            -ms-transform: translateX(22px);
            transform: translateX(22px);
        }
        
        /* --- Main Content --- */
        #content-container {
            padding: 1rem;
        }

        .page-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
            /* NEW: For fav button */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loader {
            text-align: center;
            font-size: 1.5rem;
            padding: 3rem;
        }

        .error-message {
            background: #5a1d1d;
            color: white;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
        }

        /* --- Home Page (Matches) --- */
        .league-group {
            margin-bottom: 2rem;
        }

        .league-header {
            font-size: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }
        
        .league-header-link {
            font-size: 1.5rem;
            color: var(--text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.75rem; 
            flex-grow: 1;
            overflow: hidden;
            white-space: nowrap;
        }

        .league-header-link:hover {
            color: var(--accent-color);
        }
        
        .league-header-link span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .league-header-logo {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

        .matches-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem; /* Space between cards */
        }

        .match-card {
            background-color: var(--bg-panel);
            border-radius: 8px;
            padding: 1rem;
            text-decoration: none;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex-basis: 350px;
            flex-grow: 0;
            align-items: center;
            text-align: center;
            border: 2px solid transparent; 
        }

        .match-card.is-live {
            border-color: var(--accent-color);
        }

        .match-league {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            width: 100%;
            justify-content: center; /* Center align it */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .match-league img {
            width: 20px; /* Small league logo */
            height: 20px;
            flex-shrink: 0; /* Prevent logo from shrinking */
        }
        
        .match-league span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        @media (max-width: 600px) {
            .match-card {
                flex-basis: calc(50% - 0.5rem);
                min-width: 150px;
            }
        }
        
        @media (max-width: 400px) {
            .match-card {
                flex-basis: 100%;
            }
        }

        .match-status {
            text-align: center;
            font-size: 1rem;
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .match-status.not-started {
            color: var(--text-secondary);
            font-weight: normal;
            font-size: 0.9rem;
        }

        .match-teams {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 0.25rem;
            width: 100%;
        }

        .team {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 0.5rem; 
            width: 100%;
        }

        .team img {
            width: 36px;
            height: 36px;
        }

        .team-name {
            font-size: 0.9rem; 
            font-weight: bold;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }

        .team-name.team-link {
            cursor: pointer;
        }
        .team-name.team-link:hover {
            text-decoration: underline;
            color: var(--accent-color);
        }

        .score-container {
            font-size: 1.4rem;
            font-weight: bold;
            text-align: center;
            margin: 0.25rem 0;
        }
        
        .fav-toggle {
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0;
            /* NEW: Ensure it doesn't shrink */
            flex-shrink: 0;
        }

        /* --- League Page & Match Page Tabs --- */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .tab-button {
            padding: 0.75rem 1rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: bold;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .standings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .standings-table th,
        .standings-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .standings-table th {
            background: var(--bg-panel);
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        
        .standings-table td.rank {
            font-weight: bold;
            width: 30px;
        }
        
        .standings-table td.team-cell {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .standings-table img {
            width: 24px;
            height: 24px;
        }

        .group-title {
            font-size: 1.3rem;
            color: var(--accent-color);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .stats-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--bg-panel);
            padding: 0.75rem;
            border-radius: 4px;
        }
        
        .stat-item .rank {
            font-size: 1.2rem;
            font-weight: bold;
            width: 30px;
        }
        
        .stat-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }
        
        .stat-item-info {
            flex-grow: 1;
        }
        
        .stat-item-player {
            font-weight: bold;
        }
        
        .stat-item-team {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .stat-item-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* --- Match Details Page --- */
        .match-details-header {
            text-align: center;
            background: var(--bg-panel);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .match-details-header .league {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .match-details-teams {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }
        
        .match-details-team {
            width: 35%;
            text-align: center;
        }
        
        .match-details-team img {
            width: 60px;
            height: 60px;
            margin-bottom: 0.5rem;
        }
        
        .match-details-team h2 {
            font-size: 1.2rem;
        }
        
        .match-details-score {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .match-details-status {
            font-size: 1rem;
            color: var(--accent-color);
            margin-top: 0.5rem;
        }
        
        .live-track-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg-panel);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }
        
        .match-details-info {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }
        
        .match-events {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .event-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
        }
        
        .event-item.home-event {
            /* No change */
        }
        
        .event-item.away-event {
            flex-direction: row-reverse;
            text-align: right;
        }
        
        .event-time {
            font-weight: bold;
            width: 40px;
        }
        
        .event-icon {
            font-size: 1rem;
        }
        
        .event-player {
            font-weight: bold;
        }
        
        .event-detail {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* NEW: Statistics Tab */
        .stats-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .stat-row {
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            background: var(--bg-panel);
            border-radius: 4px;
            overflow: hidden;
        }
        .stat-value {
            padding: 0.75rem;
            font-weight: bold;
            width: 80px;
            text-align: center;
        }
        .stat-name {
            flex-grow: 1;
            text-align: center;
            font-weight: bold;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* NEW: Lineup Tab */
        .lineup-container {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap; /* For small screens */
        }
        .lineup-team {
            flex: 1;
            min-width: 250px;
            background: var(--bg-panel);
            padding: 1rem;
            border-radius: 8px;
        }
        .lineup-team h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }
        .lineup-team img {
            width: 30px;
            height: 30px;
        }
        .lineup-info {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        .lineup-list {
            list-style: none;
            padding: 0;
        }
        .lineup-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .lineup-list li:last-child {
            border-bottom: none;
        }
        .lineup-list .player-number {
            display: inline-block;
            width: 30px;
            font-weight: bold;
            color: var(--text-secondary);
        }
        .lineup-list-title {
            font-weight: bold;
            color: var(--accent-color);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        /* NEW: H2H Tab */
        .h2h-container .matches-container {
            /* Re-use existing styles */
        }
        .h2h-container h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        
        /* --- Team Page --- */
        .team-info-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            background: var(--bg-panel);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .team-info-header img {
            width: 80px;
            height: 80px;
        }
        
        .team-info-details h2 {
            font-size: 1.8rem;
            display: flex; /* For fav button */
            align-items: center;
            gap: 0.5rem;
        }
        
        .team-info-details p {
            font-size: 1rem;
            color: var(--text-secondary);
        }
        
        /* --- Footer --- */
        #app-footer {
            text-align: center;
            padding: 1.5rem 1rem;
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            align-items: center;
        }
        
        #change-user-btn,
        #reset-settings-btn,
        #update-settings-btn,
        #theme-select {
            /* Use the reusable class */
            background: var(--bg-element);
            color: var(--text-primary);
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
        }
        
        #theme-select {
            padding-right: 1.5rem; /* For select arrow */
        }
        
        /* --- Theme Overrides (NEW & DEEPER) --- */
        
        /* Dark Red Theme */
        .theme-dark-red {
            --bg-body: #1a0b0b;
            --bg-panel: #2b1111;
            --bg-element: #4a1c1c;
            --text-primary: #f0e0e0;
            --text-secondary: #c0a0a0;
            --border-color: #4a1c1c;
            --accent-color: #ff6464;
        }

        /* Darky Dark Theme */
        .theme-darky-dark {
            --bg-body: #121212;
            --bg-panel: #1e1e1e;
            --bg-element: #333333;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #333333;
            --accent-color: #bb86fc;
        }
        
        /* Light Theme */
        .theme-light {
            --bg-body: #f0f2f5;
            --bg-panel: #ffffff;
            --bg-element: #e4e6eb;
            --text-primary: #1c1e21;
            --text-secondary: #65676b;
            --border-color: #dddfe2;
            --accent-color: #006aff;
        }
        
        /* --- NEW THEMES --- */
        
        /* Morocco (Dark) */
        .theme-morocco {
            --bg-body: #002a16; /* Dark Green */
            --bg-panel: #003f22;
            --bg-element: #005a31;
            --text-primary: #f0f0f0;
            --text-secondary: #b0b0b0;
            --border-color: #005a31;
            --accent-color: #C1272D; /* Red */
        }
        
        /* Morocco Away (Light) */
        .theme-morocco-away {
            --bg-body: #f0f2f5;
            --bg-panel: #ffffff;
            --bg-element: #e4e6eb;
            --text-primary: #1c1e21;
            --text-secondary: #65676b;
            --border-color: #dddfe2;
            --accent-color: #006233; /* Green */
        }
        
        /* USK (Dark) */
        .theme-usk {
            --bg-body: #1a0b0b; /* Dark Red */
            --bg-panel: #2b1111;
            --bg-element: #4a1c1c;
            --text-primary: #f0e0e0;
            --text-secondary: #c0a0a0;
            --border-color: #4a1c1c;
            --accent-color: #FFFFFF; /* White */
        }
        
        /* Raja (Dark) */
        .theme-raja {
            --bg-body: #002a16; /* Dark Green */
            --bg-panel: #003f22;
            --bg-element: #005a31;
            --text-primary: #FFFFFF;
            --text-secondary: #c0c0c0;
            --border-color: #005a31;
            --accent-color: #FFFFFF; /* White */
        }
        
        
        .theme-light .match-card,
        .theme-light .modal-content,
        .theme-light .standings-table th,
        .theme-light .stat-item,
        .theme-light .match-details-header,
        .theme-light .team-info-header,
        .theme-light .lineup-team, /* NEW */
        .theme-light .stat-row /* NEW */
        {
            border: 1px solid var(--border-color);
        }

        .theme-light .match-card.is-live {
             border: 2px solid var(--accent-color);
        }

    </style>
</head>
<body>

<div id="app-wrapper"> <!-- New wrapper for max-width -->

    <!-- This modal will show on first load to get the username -->
    <div id="user-modal">
        <div class="modal-content">
            <h2>Welcome</h2>
            <p>Please enter your username to load your settings.</p>
            <input type="text" id="username-input" placeholder="Your Username">
            <button id="user-submit" class="date-nav-button">Load Settings</button>
        </div>
    </div>

    <!-- The header is static, but its content will be built by JS -->
    <header id="app-header">
        <!-- JS will populate this -->
    </header>

    <!-- All page content will be injected here -->
    <main id="content-container">
        <div class="loader">Loading...</div>
    </main>

    <footer id="app-footer">
        <div>
            <label for="theme-select" style="margin-right: 0.5rem; font-size: 0.9rem;">Theme:</label>
            <select id="theme-select">
                <option value="dark-bleu">Dark Blue</option>
                <option value="dark-red">Dark Red</option>
                <option value="darky-dark">Darky Dark</option>
                <option value="light">Light</option>
                <!-- NEW OPTIONS -->
                <option value="morocco">Morocco</option>
                <option value="morocco-away">Morocco Away</option>
                <option value="usk">USK</option>
                <option value="raja">Raja</option>
            </select>
        </div>
        <button id="update-settings-btn">Update Favs from Source</button>
        <button id="reset-settings-btn">Reset All Settings</button>
        <button id="change-user-btn">Change User</button>
    </footer>

</div> <!-- End #app-wrapper -->

            <script>
        // Start of self-contained JavaScript application
            (function() {
            "use strict";

            // --- Configuration ---
            const API_HOST = "https://v3.football.api-sports.io";
            
            // --- App State ---
            let currentDate = new Date(); 
            let appConfig = null; // Will hold users/{username}.json
            let appSettings = null; // Will hold users/app.json
            let liveMatchTimer = null;
            let homePageTimer = null; // NEW: Timer for home page refresh
            let homePageLoadAllState = false; // NEW: State for home page "load all"
            let loadedUsername = 'default'; // NEW: Global state for current user

            // --- Storage Service ---
            // Stores username and the user's config
            const Storage = {
                getUsername: () => localStorage.getItem('football_username'),
                setUsername: (username) => localStorage.setItem('football_username', username),
                clearUsername: () => localStorage.removeItem('football_username'),
                
                getLocalConfig: () => JSON.parse(localStorage.getItem('app_config')) || null,
                setLocalConfig: (config) => localStorage.setItem('app_config', JSON.stringify(config)),
                clearLocalConfig: () => localStorage.removeItem('app_config'),
            };
            
            // --- Config & Favs Helper ---
            const Config = {
                getApiKey: () => appConfig ? appConfig.api_key : null,
                isFav: (type, id) => {
                    if (!appConfig) return false;
                    const idNum = Number(id);
                    if (type === 'team') {
                        return appConfig.favourit_teams && appConfig.favourit_teams.some(team => team.id === idNum);
                    }
                    if (type === 'league') {
                        if (idNum === 0) return appConfig.favourit_teams && appConfig.favourit_teams.length > 0;
                        return appConfig.favourite_leagues && appConfig.favourite_leagues.some(league => league.id === idNum);
                    }
                    return false;
                },
                getAllowedLeagues: () => appSettings ? appSettings.allowed_leagues : [],
                
                // NEW: Get TV remote key mappings
                getTvKeys: () => {
                    const defaults = {
                        next_day: "VolumeUp",
                        prev_day: "VolumeDown",
                        live_on: "AudioVolumeMute",
                        live_off: "AudioVolumeUp" // Default 'unmute' is VolUp, user should configure
                    };
                    if (appConfig && appConfig.tv_remote_keys) {
                        // User's config overrides defaults
                        return { ...defaults, ...appConfig.tv_remote_keys };
                    }
                    // Return defaults if no user config
                    return defaults;
                }
            };

            // NEW: Global keydown handler for TV remote
            function handleTvKeydown(event) {
                // Do nothing if config isn't loaded
                if (!appConfig) return;

                // Only act if we are on the home page (header buttons exist)
                const nextDayBtn = document.getElementById('next-day');
                const prevDayBtn = document.getElementById('prev-day');
                const liveToggle = document.getElementById('live-toggle');

                // If these buttons don't exist, we're not on the home page, so do nothing.
                if (!nextDayBtn || !prevDayBtn || !liveToggle) {
                    return;
                }

                const keys = Config.getTvKeys();

                switch (event.key) {

                    case keys.next_day:
                        event.preventDefault(); // Stop native volume change
                        nextDayBtn.click();
                        break;
                    case keys.prev_day:
                        event.preventDefault(); // Stop native volume change
                        prevDayBtn.click();
                        break;
                    case keys.live_on:
                        event.preventDefault(); // Stop native mute
                        if (!liveToggle.checked || keys.live_off==keys.live_on) {
                            liveToggle.click();
                        }
                        break;
                    case keys.live_off:
                        event.preventDefault(); // Stop native volume change
                        if (liveToggle.checked) {
                            liveToggle.click();
                        }
                        break;
                }
            }

            // --- API Service ---
            // Handles all fetching with backoff and error handling
            async function apiFetch(endpoint) {
                const apiKey = Config.getApiKey(); // Get key from loaded user config
                if (!apiKey) {
                    throw new Error("API Key not set or config not loaded.");
                }

                const url = `${API_HOST}/${endpoint}`;
                let attempts = 0;
                
                while (attempts < 3) {
                    try {
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'x-rapidapi-host': "v3.football.api-sports.io",
                                'x-rapidapi-key': apiKey
                            }
                        });

                        if (!response.ok) {
                            // NEW: Handle 204 No Content gracefully
                            if (response.status === 204) {
                                console.warn(`API warning for ${endpoint}: 204 No Content`);
                                return []; // Return empty array
                            }
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        
                        // MODIFIED: Broader error checking
                        if (data.errors && Object.keys(data.errors).length > 0) {
                            console.error("API Errors:", data.errors);
                            if (data.errors.token || data.errors.key) {
                                showError(document.getElementById('content-container'), "Invalid API Key. Please ask the administrator to check the config file.");
                                return;
                            }
                            // NEW: Handle "not found" or "bad request" gracefully by returning empty
                            if (data.errors.requests || data.errors.endpoint) {
                                console.warn(`API warning for ${endpoint}: ${JSON.stringify(data.errors)}`);
                                return []; // Return empty array for things like stats/lineup not found
                            }
                            throw new Error(JSON.stringify(data.errors));
                        }

                        return data.response; // Success
                    } catch (error) {
                        console.error(`API fetch error (attempt ${attempts + 1}):`, error);
                        attempts++;
                        if (attempts < 3) {
                            await new Promise(res => setTimeout(res, 1000 * attempts)); // Exponential backoff
                        } else {
                            throw error; // Final attempt failed
                        }
                    }
                }
            }

            // --- UI Rendering Functions ---

            /**
             * NEW: Plays a simple notification sound
             * Uses Web Audio API for no-file-needed sound.
             */
            function playSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime); // Start tone
                    oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.05);
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); // Volume
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                } catch (error) {
                    console.warn("Could not play sound:", error);
                }
            }

            function showLoader(container) {
                container.innerHTML = '<div class="loader">Loading...</div>';
            }

            function showError(container, message) {
                container.innerHTML = `<div class="error-message">Error: ${message}</div>`;
            }

            function formatDate(date) {
                return date.toISOString().split('T')[0];
            }
            
            function getCurrentSeason() {
                const today = new Date();
                const month = today.getMonth(); // 0-11
                return (month < 6) ? today.getFullYear() - 1 : today.getFullYear();
            }

            function renderHeader(container) {
                // NEW: Reads from global loadedUsername state
                container.innerHTML = `
                    <span class="header-username">User: ${loadedUsername}</span>
                    <h1>Lite Football</h1>
                    <div class="date-nav">
                        <button id="prev-day" class="styled-button">&lt;</button>
                        <span id="current-date">${formatDate(currentDate)}</span>
                        <button id="next-day" class="styled-button">&gt;</button>
                    </div>
                    <div class="live-toggle">
                        <label class="switch-toggle">
                           <input type="checkbox" id="live-toggle">
                           <span class="slider"></span>
                        </label>
                        <label for="live-toggle" style="margin-left: 0.5rem;">Live</label>
                    </div>
                `;

                // Bind events
                document.getElementById('prev-day').addEventListener('click', () => {
                    currentDate.setDate(currentDate.getDate() - 1);
                    document.getElementById('live-toggle').checked = false;
                    loadHomePageMatches();
                });
                document.getElementById('next-day').addEventListener('click', () => {
                    currentDate.setDate(currentDate.getDate() + 1);
                    document.getElementById('live-toggle').checked = false;
                    loadHomePageMatches();
                });
                document.getElementById('live-toggle').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        currentDate = new Date(); // Live is always today
                    }
                    loadHomePageMatches();
                });
            }
            
            function renderMatchCard(match, isFavSectionMatch = false) {
                const fixture = match.fixture;
                const league = match.league;
                const teams = match.teams;
                const goals = match.goals;
                const status = fixture.status.short;

                const isLive = !['NS', 'FT', 'PST', 'CANC', 'ABD'].includes(status);

                let scoreText;
                let statusText = fixture.status.long;

                if (status === 'NS') {
                    scoreText = '-';
                    statusText = new Date(fixture.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    scoreText = `${goals.home ?? '0'} - ${goals.away ?? '0'}`;
                    if (isLive || status === 'HT') {
                         statusText = `${fixture.status.long} ${fixture.status.elapsed ? `(${fixture.status.elapsed}')` : ''}`;
                    } else {
                        statusText = fixture.status.long;
                    }
                }
                
                const isFavHome = Config.isFav('team', teams.home.id);
                const isFavAway = Config.isFav('team', teams.away.id);

                const leagueHtml = isFavSectionMatch ? `
                    <div class="match-league" title="${league.name}">
                        ${league.logo ? `<img src="${league.logo}" alt="">` : ''}
                        <span>${league.name}</span>
                    </div>
                ` : '';

                return `
                    <a href="#/match/${fixture.id}" class="match-card ${isLive ? 'is-live' : ''}">
                        ${leagueHtml}
                        <div class="match-status ${status === 'NS' ? 'not-started' : ''}">
                            ${statusText}
                        </div>
                        <div class="match-teams">
                            <div class="team">
                                <img src="${teams.home.logo}" alt="${teams.home.name}">
                                <span class="team-name team-link" data-team-id="${teams.home.id}">${teams.home.name}</span>
                                <span class="fav-toggle" data-type="team" data-id="${teams.home.id}">
                                    ${isFavHome ? '‚≠ê' : '‚òÜ'}
                                </span>
                            </div>
                            <div class="score-container">${scoreText}</div>
                            <div class="team">
                                <img src="${teams.away.logo}" alt="${teams.away.name}">
                                <span class="team-name team-link" data-team-id="${teams.away.id}">${teams.away.name}</span>
                                <span class="fav-toggle" data-type="team" data-id="${teams.away.id}">
                                    ${isFavAway ? '‚≠ê' : '‚òÜ'}
                                </span>
                            </div>
                        </div>
                    </a>
                `;
            }
            
            /**
             * Adds click listeners to all .fav-toggle and .team-link elements in a container
             */
            function addCardListeners(container) {
                container.querySelectorAll('.fav-toggle').forEach(toggle => {
                    toggle.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        const type = e.currentTarget.dataset.type;
                        const id = Number(e.currentTarget.dataset.id);
                        
                        if (!type || !id || !appConfig) return;
                        
                        let favArray;
                        if (type === 'team') {
                            if (!appConfig.favourit_teams) appConfig.favourit_teams = [];
                            favArray = appConfig.favourit_teams;
                        } else if (type === 'league') {
                            if (!appConfig.favourite_leagues) appConfig.favourite_leagues = [];
                            favArray = appConfig.favourite_leagues;
                        } else {
                            return;
                        }

                        const index = favArray.findIndex(item => item.id === id);
                        
                        if (index > -1) {
                            favArray.splice(index, 1);
                            e.currentTarget.textContent = '‚òÜ';
                        } else {
                            let name = 'Unknown';
                            
                            if (type === 'team') {
                                // Try finding name from team-info or team-cell
                                let teamNameEl = e.currentTarget.closest('.team-info-details')?.querySelector('h2');
                                if (!teamNameEl) teamNameEl = e.currentTarget.closest('.team-cell')?.querySelector('a');
                                if (!teamNameEl) teamNameEl = e.currentTarget.closest('.team')?.querySelector('.team-name');
                                name = teamNameEl ? teamNameEl.textContent.replace('‚≠ê','').replace('‚òÜ','').trim() : 'Unknown Team';
                            } else if (type === 'league') {
                                if (id === 0) {
                                    name = 'Favorites';
                                } else {
                                    // Try finding name from page-title or league-header
                                    let leagueNameEl = e.currentTarget.closest('.page-title')?.querySelector('span');
                                    if (!leagueNameEl) leagueNameEl = e.currentTarget.closest('.league-header')?.querySelector('.league-header-link span');
                                    name = leagueNameEl ? leagueNameEl.textContent : 'Unknown League';
                                }
                            }
                            
                            favArray.push({ id: id, name: name });
                            e.currentTarget.textContent = '‚≠ê';
                        }
                        
                        Storage.setLocalConfig(appConfig);
                    });
                });
                
                container.querySelectorAll('.team-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault(); 
                        e.stopPropagation(); 
                        
                        const teamId = e.currentTarget.dataset.teamId;
                        if (teamId) {
                            window.location.hash = `#/team/${teamId}`;
                        }
                    });
                });
            }
            
            // --- NEW: Match Page Tab Renderers ---
            
            function renderEvent(event) {
                let icon = '';
                let detail = event.detail;
                if (event.type === 'Goal') icon = '‚öΩ';
                if (event.type === 'subst') icon = 'üîÑ';
                if (event.type === 'Card') icon = event.detail === 'Yellow Card' ? 'üü®' : 'üü•';
                
                return `
                    <div class="event-item ${event.team.id === window.currentMatchHomeTeamId ? 'home-event' : 'away-event'}">
                        <div class="event-time">${event.time.elapsed}'</div>
                        <div class="event-icon">${icon}</div>
                        <div class="event-info">
                            <div class="event-player">${event.player.name}</div>
                            <div class="event-detail">${event.assist.name ? `Assist: ${event.assist.name}` : detail}</div>
                        </div>
                    </div>
                `;
            }
            
            function renderLineup(lineupData) {
                if (!lineupData || lineupData.length < 2) return '<p>Lineups not available.</p>';
                
                const home = lineupData[0];
                const away = lineupData[1];
                
                const renderPlayerList = (players) => {
                    return players.map(p => `
                        <li>
                            <span class="player-number">${p.player.number}</span>
                            ${p.player.name}
                        </li>
                    `).join('');
                };
                
                return `
                    <div class="lineup-container">
                        <div class="lineup-team">
                            <h3><img src="${home.team.logo}" alt=""> ${home.team.name}</h3>
                            <div class="lineup-info">
                                Manager: ${home.coach.name || 'N/A'}<br>
                                Formation: ${home.formation || 'N/A'}
                            </div>
                            
                            <div class="lineup-list-title">Starting XI</div>
                            <ul class="lineup-list">${renderPlayerList(home.startXI)}</ul>
                            
                            <div class="lineup-list-title">Substitutes</div>
                            <ul class="lineup-list">${renderPlayerList(home.substitutes)}</ul>
                        </div>
                        <div class="lineup-team">
                            <h3><img src="${away.team.logo}" alt=""> ${away.team.name}</h3>
                            <div class="lineup-info">
                                Manager: ${away.coach.name || 'N/A'}<br>
                                Formation: ${away.formation || 'N/A'}
                            </div>
                            
                            <div class="lineup-list-title">Starting XI</div>
                            <ul class="lineup-list">${renderPlayerList(away.startXI)}</ul>
                            
                            <div class="lineup-list-title">Substitutes</div>
                            <ul class="lineup-list">${renderPlayerList(away.substitutes)}</ul>
                        </div>
                    </div>
                `;
            }
            
            function renderStatistics(statsData) {
                if (!statsData || statsData.length < 2) return '<p>Statistics not available.</p>';
                
                const home = statsData[0];
                const away = statsData[1];
                
                const statsMap = new Map();
                
                home.statistics.forEach(stat => {
                    statsMap.set(stat.type, { home: stat.value ?? 0 });
                });
                
                away.statistics.forEach(stat => {
                    const existing = statsMap.get(stat.type) || { home: 0 };
                    existing.away = stat.value ?? 0;
                    statsMap.set(stat.type, existing);
                });
                
                let html = `<div class="stats-container">`;
                statsMap.forEach((values, type) => {
                    html += `
                        <div class="stat-row">
                            <div class="stat-value">${values.home}</div>
                            <div class="stat-name">${type}</div>
                            <div class="stat-value">${values.away}</div>
                        </div>
                    `;
                });
                html += `</div>`;
                
                return html;
            }
            
            function renderH2H(h2hData) {
                if (!h2hData || h2hData.length === 0) return '<p>No head-to-head data available.</p>';
                
                // Summarize H2H
                const homeTeamId = h2hData[0].teams.home.id;
                let homeWins = 0;
                let awayWins = 0;
                let draws = 0;
                
                h2hData.forEach(match => {
                    if (match.fixture.status.short !== 'FT') return; // Only count finished matches
                    
                    if (match.goals.home === match.goals.away) {
                        draws++;
                    } else if (match.teams.home.id === homeTeamId) {
                        if (match.goals.home > match.goals.away) homeWins++;
                        else awayWins++;
                    } else {
                        if (match.goals.home > match.goals.away) awayWins++;
                        else homeWins++;
                    }
                });

                return `
                    <div class="h2h-container">
                        <h3>${homeWins} Wins | ${draws} Draws | ${awayWins} Wins</h3>
                        <div class="matches-container">
                            ${h2hData.map(match => renderMatchCard(match, true)).join('')}
                        </div>
                    </div>
                `;
            }


            // --- Page Controllers ---

            async function renderHomePage(container) {
                const headerContainer = document.getElementById('app-header');
                renderHeader(headerContainer);
                container.innerHTML = '<div class="loader">Loading matches...</div>';
                
                // NEW: Reset load all state on fresh page load
                homePageLoadAllState = false; 
                await loadHomePageMatches(false, false);
            }

            /**
             * Fetches and renders matches for the home page
             * NEW: Added loadAll and isRefresh parameters
             */
            async function loadHomePageMatches(loadAll = false, isRefresh = false) {
                // NEW: Update global state
                if (loadAll) {
                    homePageLoadAllState = true;
                }
                
                const container = document.getElementById('content-container');
                const isLive = document.getElementById('live-toggle') ? document.getElementById('live-toggle').checked : false;
                const date = formatDate(currentDate);
                
                if (document.getElementById('current-date')) {
                    document.getElementById('current-date').textContent = date;
                }
                
                // NEW: Only show loader if not a background refresh
                if (!isRefresh) {
                    showLoader(container);
                }

                try {
                    const allowedLeagues = Config.getAllowedLeagues();
                    const allowedLeagueIds = allowedLeagues.map(l => l.id);

                    if (allowedLeagueIds.length === 0) {
                        console.warn("No allowed leagues configured. Please check 'users/app.json'. Only favorite team matches will be shown.");
                    }
                    
                    let endpoint = `fixtures?date=${date}&season=${getCurrentSeason()}`;
                    if (isLive) {
                        endpoint = `fixtures?live=all`;
                    }
                    
                    const matchesResponse = await apiFetch(endpoint);
                    
                    const favTeamIds = new Set((appConfig.favourit_teams || []).map(team => team.id));
                    const favLeagueIds = new Set((appConfig.favourite_leagues || []).map(league => league.id));

                    const favTeamMatches = [];
                    const favLeagueMatches = [];
                    const otherMatches = []; 

                    for (const match of matchesResponse) {
                        const leagueId = match.league.id;
                        const isFavTeamMatch = favTeamIds.has(match.teams.home.id) || favTeamIds.has(match.teams.away.id);
                        const isFavLeagueMatch = favLeagueIds.has(leagueId);

                        if (isFavTeamMatch) {
                            favTeamMatches.push(match);
                        } 
                        else if (isFavLeagueMatch) {
                            favLeagueMatches.push(match);
                        } 
                        else {
                            otherMatches.push(match);
                        }
                    }
                    
                    // NEW: Filter 'other' matches based on homePageLoadAllState
                    const allowedOtherMatches = (homePageLoadAllState) 
                        ? otherMatches 
                        : otherMatches.filter(m => allowedLeagueIds.includes(m.league.id));
                    
                    const favLeagueGroups = {};
                    const otherLeagueGroups = {};

                    for (const match of favLeagueMatches) {
                        const leagueId = match.league.id;
                        const leagueName = match.league.name;
                        if (!favLeagueGroups[leagueId]) {
                             favLeagueGroups[leagueId] = { name: leagueName, logo: match.league.logo, matches: [] };
                        }
                        favLeagueGroups[leagueId].matches.push(match);
                    }

                    for (const match of allowedOtherMatches) { 
                        const leagueId = match.league.id;
                        const leagueName = match.league.name;
                        if (!otherLeagueGroups[leagueId]) {
                            otherLeagueGroups[leagueId] = { name: leagueName, logo: match.league.logo, matches: [] };
                        }
                        otherLeagueGroups[leagueId].matches.push(match);
                    }


                    // --- Render HTML ---
                    let html = '';

                    if (favTeamMatches.length > 0) {
                        const isFav = Config.isFav('league', 0);
                        html += `
                            <div class="league-group">
                                <div class="league-header">
                                    <span>‚≠ê Favorites</span>
                                    <span class="fav-toggle" data-type="league" data-id="0">${isFav ? '‚≠ê' : '‚òÜ'}</span>
                                </div>
                                <div class="matches-container">
                                    ${favTeamMatches.map(match => renderMatchCard(match, true)).join('')}
                                </div>
                            </div>
                        `;
                    }

                    const renderLeagueGroup = (leagueId, group) => {
                        const isFav = Config.isFav('league', leagueId);
                        const leagueLogoHtml = group.logo ? `<img src="${group.logo}" alt="" class="league-header-logo">` : '';
                        return `
                            <div class="league-group">
                                <div class="league-header">
                                    <a href="#/league/${leagueId}" class="league-header-link">
                                        ${leagueLogoHtml}
                                        <span>${group.name}</span>
                                    </a>
                                    <span class="fav-toggle" data-type="league" data-id="${leagueId}">${isFav ? '‚≠ê' : '‚òÜ'}</span>
                                </div>
                                <div class="matches-container">
                                    ${group.matches.map(match => renderMatchCard(match, false)).join('')}
                                </div>
                            </div>
                        `;
                    };

                    for (const leagueId in favLeagueGroups) {
                        html += renderLeagueGroup(leagueId, favLeagueGroups[leagueId]);
                    }
                    
                    for (const leagueId in otherLeagueGroups) {
                        html += renderLeagueGroup(leagueId, otherLeagueGroups[leagueId]);
                    }
                    
                    if (html === '') {
                        html = '<p>No matches found for this date.</p>';
                    }
                    
                    // NEW: Add "Load All" button if not already loaded
                    if (!homePageLoadAllState) {
                         html += `
                            <div style="text-align: center; margin-top: 1.5rem;">
                                <button id="load-all-matches-btn" class="styled-button" style="padding: 0.75rem 1rem;">
                                    Load All Matches (Ignore Filters)
                                </button>
                            </div>
                         `;
                    }

                    container.innerHTML = html;
                    
                    addCardListeners(container);
                    
                    // NEW: Bind the "Load All" button
                    const loadAllBtn = container.querySelector('#load-all-matches-btn');
                    if (loadAllBtn) {
                        loadAllBtn.addEventListener('click', () => loadHomePageMatches(true, false));
                    }

                } catch (error) {
                    if (!isRefresh) { // Don't show error on background refresh
                        showError(container, error.message);
                    } else {
                        console.error("Home page refresh failed:", error);
                    }
                }
            }

            async function renderMatchPage(container, id) {
                document.getElementById('app-header').innerHTML = `<h1><a href="#/" style="color:var(--text-primary); text-decoration:none;">Lite Football</a></h1>`;
                showLoader(container);
                
                let lastScore = '';
                let lastEventsCount = 0;
                
                try {
                    const [matchData] = await apiFetch(`fixtures?id=${id}`);
                    if (!matchData) {
                        throw new Error("Match not found.");
                    }
                    
                    const { fixture, league, teams, goals } = matchData;
                    const { home, away } = teams;
                    const h2hId = `${home.id}-${away.id}`;
                    const status = fixture.status.short;
                    
                    // NEW: Set global team ID for event renderer
                    window.currentMatchHomeTeamId = home.id;

                    const isLive = !['NS', 'FT', 'PST', 'CANC', 'ABD'].includes(status);
                    const isFinished = ['FT', 'AET', 'PEN', 'PST', 'CANC', 'ABD'].includes(status);
                    const isNotStarted = status === 'NS';
                    
                    // NEW: Fetch all data
                    const [events, lineup, statistics, headtohead] = await Promise.all([
                        apiFetch(`fixtures/events?fixture=${id}`),
                        apiFetch(`fixtures/lineups?fixture=${id}`),
                        // Only fetch stats if finished, otherwise API might return error
                        isFinished ? apiFetch(`fixtures/statistics?fixture=${id}`) : Promise.resolve([]),
                        apiFetch(`fixtures/headtohead?h2h=${h2hId}`)
                    ]);

                    lastScore = `${goals.home ?? '0'} - ${goals.away ?? '0'}`;
                    lastEventsCount = events.length;

                    // --- NEW: Build Tabs ---
                    let tabsHtml = '<div class="tabs">';
                    let tabContentsHtml = '';
                    
                    if (isNotStarted) {
                        if (lineup && lineup.length > 0) {
                            tabsHtml += `<button class="tab-button active" data-tab="lineup">Lineup</button>`;
                            tabsHtml += `<button class="tab-button" data-tab="h2h">Head to Head</button>`;
                            tabContentsHtml += `<div id="lineup" class="tab-content active">${renderLineup(lineup)}</div>`;
                            tabContentsHtml += `<div id="h2h" class="tab-content">${renderH2H(headtohead)}</div>`;
                        } else {
                            tabsHtml += `<button class="tab-button active" data-tab="h2h">Head to Head</button>`;
                            tabsHtml += `<button class="tab-button" data-tab="lineup">Lineup</button>`;
                            tabContentsHtml += `<div id="h2h" class="tab-content active">${renderH2H(headtohead)}</div>`;
                            tabContentsHtml += `<div id="lineup" class="tab-content">${renderLineup(lineup)}</div>`;
                        }
                    } else if (isLive) {
                        tabsHtml += `<button class="tab-button active" data-tab="events">Events</button>`;
                        tabsHtml += `<button class="tab-button" data-tab="lineup">Lineup</button>`;
                        tabsHtml += `<button class="tab-button" data-tab="h2h">Head to Head</button>`;
                        tabContentsHtml += `<div id="events" class="tab-content active"><div class="match-events">${events.map(renderEvent).join('')}</div></div>`;
                        tabContentsHtml += `<div id="lineup" class="tab-content">${renderLineup(lineup)}</div>`;
                        tabContentsHtml += `<div id="h2h" class="tab-content">${renderH2H(headtohead)}</div>`;
                    } else { // Finished
                        tabsHtml += `<button class="tab-button active" data-tab="stats">Stats</button>`;
                        tabsHtml += `<button class="tab-button" data-tab="events">Events</button>`;
                        tabsHtml += `<button class="tab-button" data-tab="lineup">Lineup</button>`;
                        tabsHtml += `<button class="tab-button" data-tab="h2h">Head to Head</button>`;
                        tabContentsHtml += `<div id="stats" class="tab-content active">${renderStatistics(statistics)}</div>`;
                        tabContentsHtml += `<div id="events" class="tab-content"><div class="match-events">${events.map(renderEvent).join('')}</div></div>`;
                        tabContentsHtml += `<div id="lineup" class="tab-content">${renderLineup(lineup)}</div>`;
                        tabContentsHtml += `<div id="h2h" class="tab-content">${renderH2H(headtohead)}</div>`;
                    }
                    tabsHtml += '</div>';
                    // --- End Build Tabs ---

                    container.innerHTML = `
                        <h2 class="page-title"><span><a href="#/">Home</a> &gt; Match Details</span></h2>
                        
                        ${isLive ? `
                        <div class="live-track-controls">
                            <label class="switch-toggle">
                               <!-- NEW: Changed ID and purpose -->
                               <input type="checkbox" id="live-sound-checkbox">
                               <span class="slider"></span>
                            </label>
                            <!-- NEW: Changed label -->
                            <label for="live-sound-checkbox" style="margin-left: 0.5rem;">Sound on change</label>
                        </div>
                        ` : ''}

                        <div class="match-details-header">
                            <div class="league"><a href="#/league/${league.id}">${league.name}</a> - ${league.round}</div>
                            <div class="match-details-teams">
                                <div class="match-details-team">
                                    <a href="#/team/${home.id}">
                                        <img src="${home.logo}" alt="${home.name}">
                                        <h2>${home.name}</h2>
                                    </a>
                                </div>
                                <div class="match-details-score">${goals.home ?? '0'} - ${goals.away ?? '0'}</div>
                                <div class="match-details-team">
                                    <a href="#/team/${away.id}">
                                        <img src="${away.logo}" alt="${away.name}">
                                        <h2>${away.name}</h2>
                                    </a>
                                </div>
                            </div>
                            <div class="match-details-status">${fixture.status.long} ${fixture.status.elapsed ? `(${fixture.status.elapsed}')` : ''}</div>
                            <div class="match-details-info">
                                ${new Date(fixture.date).toLocaleString()} | ${fixture.venue.name}, ${fixture.venue.city}
                            </div>
                        </div>
                        
                        <!-- NEW: Tabs and Content -->
                        ${tabsHtml}
                        ${tabContentsHtml}
                    `;
                    
                    // --- Bind Tab Listeners ---
                    container.querySelectorAll('.tab-button').forEach(button => {
                        button.addEventListener('click', () => {
                            const tabId = button.dataset.tab;
                            
                            container.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                            container.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                            
                            button.classList.add('active');
                            const activeContent = container.querySelector(`#${tabId}`);
                            if (activeContent) activeContent.classList.add('active');
                        });
                    });
                    
                    // --- NEW: Modified Live Timer Logic ---
                    if (isLive) {
                        if (liveMatchTimer) clearInterval(liveMatchTimer); // Clear any old timer
                        
                        // Start timer unconditionally
                        liveMatchTimer = setInterval(async () => {
                            try {
                                // Refresh data
                                const [refreshedMatchData, refreshedEvents, refreshedLineup] = await Promise.all([
                                    apiFetch(`fixtures?id=${id}`),
                                    apiFetch(`fixtures/events?fixture=${id}`),
                                    apiFetch(`fixtures/lineups?fixture=${id}`)
                                ]);
                                
                                const { fixture: rFix, goals: rGoals } = refreshedMatchData[0];
                                const rStatus = rFix.status.short;
                                const rIsLive = !['NS', 'FT', 'PST', 'CANC', 'ABD'].includes(rStatus);

                                // If match finished, stop timer and reload page to get stats tab
                                if (!rIsLive) {
                                    clearInterval(liveMatchTimer);
                                    liveMatchTimer = null;
                                    window.location.reload(); 
                                    return;
                                }
                                
                                const newScore = `${rGoals.home ?? '0'} - ${rGoals.away ?? '0'}`;
                                const newEventsCount = refreshedEvents.length;

                                let changed = false;
                                if (newScore !== lastScore) {
                                    changed = true;
                                    lastScore = newScore;
                                }
                                if (newEventsCount !== lastEventsCount) {
                                    changed = true;
                                    lastEventsCount = newEventsCount;
                                }
                                
                                // NEW: Check if sound is enabled
                                const soundEnabled = document.getElementById('live-sound-checkbox')?.checked;
                                if (changed && soundEnabled) {
                                    playSound();
                                }

                                // --- Update UI ---
                                document.querySelector('.match-details-score').textContent = newScore;
                                document.querySelector('.match-details-status').textContent = `${rFix.status.long} ${rFix.status.elapsed ? `(${rFix.status.elapsed}')` : ''}`;
                                
                                // Re-render tab content
                                const eventsTab = document.getElementById('events');
                                if (eventsTab) eventsTab.innerHTML = `<div class="match-events">${refreshedEvents.map(renderEvent).join('')}</div>`;
                                
                                const lineupTab = document.getElementById('lineup');
                                if (lineupTab) lineupTab.innerHTML = renderLineup(refreshedLineup);

                            } catch (err) {
                                console.error("Error during live refresh:", err);
                                // Don't stop the timer, just log the error
                            }
                        }, 60000); // MODIFIED: 60 seconds
                    }

                } catch (error) {
                    showError(container, error.message);
                }
            }

            async function renderLeaguePage(container, id) {
                document.getElementById('app-header').innerHTML = `<h1><a href="#/" style="color:var(--text-primary); text-decoration:none;">Lite Football</a></h1>`;
                showLoader(container);
                
                try {
                    const season = getCurrentSeason();
                    // NEW: Await all, but handle potential empty standings
                    const [standingsResponse, scorersData, assistsData] = await Promise.all([
                        apiFetch(`standings?league=${id}&season=${season}`),
                        apiFetch(`players/topscorers?league=${id}&season=${season}`),
                        apiFetch(`players/topassists?league=${id}&season=${season}`),
                    ]);

                    // Use a fallback object if standings are empty but we want to show other tabs
                    const leagueInfo = standingsResponse[0]?.league || 
                                     (scorersData[0] ? scorersData[0].statistics[0].league : null) ||
                                     (assistsData[0] ? assistsData[0].statistics[0].league : null);
                    
                    if (!leagueInfo) {
                        throw new Error("League data not found.");
                    }
                    
                    // Standings might be empty, default to empty array
                    const standings = standingsResponse[0]?.league.standings || [];
                    
                    // NEW: Add fav button
                    const isFav = Config.isFav('league', leagueInfo.id);

                    container.innerHTML = `
                        <!-- NEW: Added span for title and fav-toggle -->
                        <h2 class="page-title">
                            <span><a href="#/">Home</a> &gt; ${leagueInfo.name}</span>
                            <span class="fav-toggle" data-type="league" data-id="${leagueInfo.id}">${isFav ? '‚≠ê' : '‚òÜ'}</span>
                        </h2>
                        <div class="tabs">
                            <button class="tab-button active" data-tab="standings">Standings</button>
                            <button class="tab-button" data-tab="scorers">Top Scorers</button>
                            <button class="tab-button" data-tab="assists">Top Assists</button>
                        </div>
                        
                        <div id="standings" class="tab-content active"></div>
                        <div id="scorers" class="tab-content"></div>
                        <div id="assists" class="tab-content"></div>
                    `;
                    
                    const standingsContainer = container.querySelector('#standings');
                    let standingsHtml = '';
                    if (standings.length === 0) {
                        standingsHtml = '<p>Standings not available.</p>';
                    } else {
                        for (const group of standings) {
                            if (standings.length > 1) {
                                standingsHtml += `<h3 class="group-title">${group[0].group}</h3>`;
                            }
                            standingsHtml += `
                                <table class="standings-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Team</th>
                                            <th>P</th>
                                            <th>W</th>
                                            <th>D</th>
                                            <th>L</th>
                                            <th>GD</th>
                                            <th>Pts</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${group.map(team => `
                                            <tr>
                                                <td class="rank">${team.rank}</td>
                                                <td class="team-cell">
                                                    <img src="${team.team.logo}" alt="${team.team.name}">
                                                    <a href="#/team/${team.team.id}">${team.team.name}</a>
                                                </td>
                                                <td>${team.all.played}</td>
                                                <td>${team.all.win}</td>
                                                <td>${team.all.draw}</td>
                                                <td>${team.all.lose}</td>
                                                <td>${team.goalsDiff}</td>
                                                <td><strong>${team.points}</strong></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                        }
                    }
                    standingsContainer.innerHTML = standingsHtml;
                    
                    const renderStatsList = (data) => {
                        if (data.length === 0) return '<p>Data not available.</p>';
                        return `<div class="stats-list">
                            ${data.map((item, index) => `
                                <div class="stat-item">
                                    <div class="rank">${index + 1}</div>
                                    <img src="${item.player.photo}" alt="${item.player.name}">
                                    <div class="stat-item-info">
                                        <div class="stat-item-player"><a href="#/player/${item.player.id}">${item.player.name}</a></div>
                                        <div class="stat-item-team">${item.statistics[0].team.name}</div>
                                    </div>
                                    <div class="stat-item-value">${item.statistics[0].goals.total || item.statistics[0].goals.assists}</div>
                                </div>
                            `).join('')}
                        </div>`;
                    };
                    
                    container.querySelector('#scorers').innerHTML = renderStatsList(scorersData);
                    container.querySelector('#assists').innerHTML = renderStatsList(assistsData);
                    
                    container.querySelectorAll('.tab-button').forEach(button => {
                        button.addEventListener('click', () => {
                            const tabId = button.dataset.tab;
                            
                            container.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                            container.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                            
                            button.classList.add('active');
                            container.querySelector(`#${tabId}`).classList.add('active');
                        });
                    });
                    
                    // NEW: Add listener for the fav button
                    addCardListeners(container);

                } catch (error) {
                    showError(container, error.message);
                }
            }

            async function renderTeamPage(container, id) {
                document.getElementById('app-header').innerHTML = `<h1><a href="#/" style="color:var(--text-primary); text-decoration:none;">Lite Football</a></h1>`;
                showLoader(container);
                try {
                    const [teamData] = await apiFetch(`teams?id=${id}`);
                    if (!teamData) throw new Error("Team not found.");

                    const { team, venue } = teamData;
                    const isFav = Config.isFav('team', team.id);

                    container.innerHTML = `
                        <h2 class="page-title"><span><a href="#/">Home</a> &gt; Team</span></h2>
                        <div class="team-info-header">
                            <img src="${team.logo}" alt="${team.name}">
                            <div class="team-info-details">
                                <h2>${team.name} <span class="fav-toggle" data-type="team" data-id="${team.id}">${isFav ? '‚≠ê' : '‚òÜ'}</span></h2>
                                <p>${team.country} | Founded: ${team.founded}</p>
                                <p>${venue.name}, ${venue.city} (Capacity: ${venue.capacity})</p>
                            </div>
                        </div>
                        
                        <h3 class="page-title" style="font-size: 1.3rem;">Info</h3>
                        <p>More team details like squad and recent matches could be loaded here.</p>
                    `;
                    
                    addCardListeners(container);

                } catch (error) {
                    showError(container, error.message);
                }
            }

            async function renderPlayerPage(container, id) {
                document.getElementById('app-header').innerHTML = `<h1><a href="#/" style="color:var(--text-primary); text-decoration:none;">Lite Football</a></h1>`;
                showLoader(container);
                try {
                    const [playerData] = await apiFetch(`players?id=${id}&season=${getCurrentSeason()}`);
                    if (!playerData) throw new Error("Player not found.");

                    const { player, statistics } = playerData;
                    const stats = statistics[0]; // First team stats

                    container.innerHTML = `
                        <h2 class="page-title"><span><a href="#/">Home</a> &gt; Player</span></h2>
                        <div class="team-info-header"> <!-- Re-using team header style -->
                            <img src="${player.photo}" alt="${player.name}" style="border-radius: 50%;">
                                <div class="team-info-details">
                                    <h2>${player.name} (${player.nationality})</h2>
                                    <p>Age: ${player.age} | Height: ${player.height} | Weight: ${player.weight}</p>
                                    ${stats ? `<p>Team: <a href="#/team/${stats.team.id}">${stats.team.name}</a></p>` : ''}
                                 </div>
                        </div>
                        </div>
                        
                        <h3 class="page-title" style="font-size: 1.3rem;">Season Stats (${stats ? stats.league.name : 'N/A'})</h3>
                        ${stats ? `
                            <table class="standings-table">
                                <tbody>
                                    <tr><td>Position</td><td>${stats.games.position}</td></tr>
                                    <tr><td>Appearances</td><td>${stats.games.appearences}</td></tr>
                                    <tr><td>Minutes</td><td>${stats.games.minutes}</td></tr>
                                    <tr><td>Goals</td><td>${stats.goals.total}</td></tr>
                                    <tr><td>Assists</td><td>${stats.goals.assists}</td></tr>
                                    <tr><td>Rating</td><td>${parseFloat(stats.games.rating).toFixed(2)}</td></tr>
                                </tbody>
                            </table>
                        ` : '<p>No stats available for this season.</p>'}
                    `;

                } catch (error) {
                    showError(container, error.message);
                }
            }

            // --- App Router ---
            function AppRouter() {
                // NEW: Clear ALL timers on navigation
                if (liveMatchTimer) {
                    clearInterval(liveMatchTimer);
                    liveMatchTimer = null;
                }
                if (homePageTimer) {
                    clearInterval(homePageTimer);
                    homePageTimer = null;
                }
                
                const path = window.location.hash.substring(1) || '/';
                const mainContainer = document.getElementById('content-container');

                document.getElementById('app-header').innerHTML = '';
                showLoader(mainContainer);
                
                // NEW: Clean up match-specific globals
                delete window.currentMatchHomeTeamId;

                if (path.startsWith('/match/')) {
                    const id = path.split('/')[2];
                    renderMatchPage(mainContainer, id);
                } else if (path.startsWith('/league/')) {
                    const id = path.split('/')[2];
                    renderLeaguePage(mainContainer, id);
                } else if (path.startsWith('/team/')) {
                    const id = path.split('/')[2];
                    renderTeamPage(mainContainer, id);
                } else if (path.startsWith('/player/')) {
                    const id = path.split('/')[2];
                    renderPlayerPage(mainContainer, id);
                } else {
                    renderHomePage(mainContainer);
                    // NEW: Start home page refresh timer
                    homePageTimer = setInterval(() => {
                        // Refresh with current 'loadAll' state, as a background refresh
                        loadHomePageMatches(homePageLoadAllState, true); 
                    }, 60000); // 60 seconds
                }
            }
            
            /* Applies theme class to body and sets dropdown
             */
            function applyTheme(theme) {
                const validThemes = ['dark-bleu', 'dark-red', 'darky-dark', 'light', 'morocco', 'morocco-away', 'usk', 'raja'];
                const themeToApply = validThemes.includes(theme) ? theme : 'dark-bleu';
                
                document.body.className = ''; 
                if (themeToApply !== 'dark-bleu') { 
                    document.body.classList.add(`theme-${themeToApply}`);
                }
                
                const themeSelect = document.getElementById('theme-select');
                if (themeSelect) {
                    themeSelect.value = themeToApply;
                }
            }
            
            /**
             * NEW: Loads the app.json config file *from the server*
             */
            async function loadAppSettings(onSuccessCallback) {
                try {
                    const response = await fetch(`users/app.json?_=${new Date().getTime()}`);
                    if (!response.ok) {
                        throw new Error("Could not load users/app.json");
                    }
                    appSettings = await response.json();
                    
                    if (onSuccessCallback) onSuccessCallback();
                    
                } catch (error) {
                    console.error("Fatal error loading app settings:", error);
                    showError(document.getElementById('content-container'), "Could not load core app configuration. Please contact the administrator.");
                }
            }
            
            /**
             * Loads the user config file (e.g., users/username.json)
             */
            async function loadConfigFromServer(username, onComplete) {
                let configUrl = `users/${username.toLowerCase()}.json`;
                try {
                    // NEW: Add cache buster
                    let response = await fetch(`${configUrl}?_=${new Date().getTime()}`);
                    if (!response.ok) {
                        console.warn(`User config ${configUrl} not found, falling back to default.`);
                        configUrl = 'users/default.json';
                        response = await fetch(`${configUrl}?_=${new Date().getTime()}`);
                    }
                    
                    if (!response.ok) {
                        throw new Error("Could not load default.json config.");
                    }
                    
                    appConfig = await response.json();
                    
                    if (!appConfig.favourit_teams) appConfig.favourit_teams = [];
                    if (!appConfig.favourite_leagues) appConfig.favourite_leagues = [];
                    
                    Storage.setLocalConfig(appConfig); 
                    applyTheme(appConfig.theme);
                    
                    if(onComplete) onComplete();
                    
                } catch (error) {
                    console.error("Fatal error loading user config:", error);
                    showError(document.getElementById('content-container'), "Could not load user configuration. Please check console.");
                }
            }
            
            /**
             * Fetches server config and merges favorites
             */
            async function updateFavoritesFromServer() {
                const username = Storage.getUsername();
                if (!username) return;
                
                let configUrl = `users/${username.toLowerCase()}.json`;
                try {
                    // NEW: Add cache buster
                    let response = await fetch(`${configUrl}?_=${new Date().getTime()}`);
                    if (!response.ok) {
                        configUrl = 'users/default.json';
                        response = await fetch(`${configUrl}?_=${new Date().getTime()}`);
                    }
                    if (!response.ok) throw new Error("Could not load config file for update.");
                    
                    const jsonConfig = await response.json();
                    const localConfig = Storage.getLocalConfig() || appConfig;
                    
                    const mergeById = (arr1, arr2) => {
                        const map = new Map();
                        (arr1 || []).forEach(item => map.set(item.id, item));
                        (arr2 || []).forEach(item => {
                            if (!map.has(item.id)) {
                                map.set(item.id, item);
                            }
                        });
                        return Array.from(map.values());
                    };
                    
                    const mergedTeams = mergeById(localConfig.favourit_teams, jsonConfig.favourit_teams);
                    const mergedLeagues = mergeById(localConfig.favourite_leagues, jsonConfig.favourite_leagues);
                    
                    localConfig.favourit_teams = mergedTeams;
                    localConfig.favourite_leagues = mergedLeagues;
                    
                    Storage.setLocalConfig(localConfig);
                    appConfig = localConfig;
                    
                    alert("Favorites updated!");
                    // NEW: Reload current page to reflect changes
                    AppRouter();
                    
                } catch (error) {
                    console.error("Error updating favorites:", error);
                    alert("Could not update favorites.");
                }
            }
            
            /**
             * This logic runs *after* app settings are loaded
             * MODIFIED: To load 'default' user first without showing modal.
             */
            function initUserLogic() {
                const modal = document.getElementById('user-modal');
                modal.classList.remove('visible'); // Always ensure it's hidden on load
                
                const username = Storage.getUsername();
                loadedUsername = username || 'default'; // Set global state
                
                appConfig = Storage.getLocalConfig();
                
                if (appConfig) {
                    applyTheme(appConfig.theme);
                    AppRouter();
                } else {
                    // Load config and *then* route
                    loadConfigFromServer(loadedUsername, AppRouter);
                }
            }
            
            /**
             * First function to run on load
             */
            function init() {
                // NEW: Add TV remote listener
                document.addEventListener('keydown', handleTvKeydown);
                
                document.getElementById('change-user-btn').addEventListener('click', () => {
                    document.getElementById('user-modal').classList.add('visible');
                });
                
                document.getElementById('user-submit').onclick = () => {
                    const newUsername = document.getElementById('username-input').value;
                    if (newUsername) {
                        Storage.setUsername(newUsername);
                        Storage.clearLocalConfig(); 
                        window.location.reload();
                    } else {
                        document.getElementById('user-modal').classList.remove('visible');
                    }
                };
                
                document.getElementById('reset-settings-btn').addEventListener('click', () => {
                    Storage.clearUsername();
                    Storage.clearLocalConfig();
                    window.location.reload();
                });
                
                document.getElementById('update-settings-btn').addEventListener('click', updateFavoritesFromServer);
                
                document.getElementById('theme-select').addEventListener('change', (e) => {
                    const newTheme = e.target.value;
                    if (appConfig) { 
                        appConfig.theme = newTheme;
                        Storage.setLocalConfig(appConfig);
                    }
                    applyTheme(newTheme);
                });
                
                loadAppSettings(initUserLogic);
            }

            // --- Start the App ---
            document.addEventListener('DOMContentLoaded', init);
            window.addEventListener('hashchange', AppRouter);

        })();
    </script>
</body>
</html>