<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lite Football</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDKs (Compat version for easier drop-in) -->
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-auth-compat.js"></script>
    
</head>
<body>

<div id="app-wrapper"> <!-- New wrapper for max-width -->

    <!-- Auth Modal (Replaced old user-modal) -->
    <div id="auth-modal">
        <div class="modal-content">
            <span id="modal-close-btn" class="modal-close">&times;</span>
            <h2 id="auth-title">Sign In</h2>
            <p id="auth-message">Please sign in to save your settings.</p>
            
            <input type="email" id="auth-email" placeholder="Email Address" required>
            <input type="password" id="auth-password" placeholder="Password" required>
            
            <div id="auth-error" style="color: #ff6464; margin-bottom: 1rem; font-size: 0.9rem; min-height: 1.2em;"></div>
            
            <button id="btn-login" class="styled-button" style="width: 100%; margin-bottom: 0.5rem;">Sign In</button>
            <button id="btn-signup" class="styled-button" style="width: 100%; display: none;">Sign Up</button>
            
            <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                <span id="auth-toggle-text">Don't have an account?</span> 
                <a href="#" id="auth-toggle-link" style="font-weight: bold;">Sign Up</a>
            </div>
        </div>
    </div>

    <!-- The header is static, but its content will be built by JS -->
    <header id="app-header">
        <!-- JS will populate this -->
    </header>

    <!-- All page content will be injected here -->
    <main id="content-container">
        <div class="loader">Loading...</div>
    </main>

    <footer id="app-footer">
        <div>
            <label for="theme-select" style="margin-right: 0.5rem; font-size: 0.9rem;">Theme:</label>
            <select id="theme-select">
                <option value="dark-bleu">Dark Blue</option>
                <option value="dark-red">Dark Red</option>
                <option value="darky-dark">Darky Dark</option>
                <option value="light">Light</option>
                <option value="morocco">Morocco</option>
                <option value="morocco-away">Morocco Away</option>
                <option value="usk">USK</option>
                <option value="raja">Raja</option>
            </select>
        </div>
        <button id="btn-auth-action">Login</button>
    </footer>

</div> <!-- End #app-wrapper -->

<script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyClgzoMBEKizx-r7abMvAmLgGpk_p748IU",
        authDomain: "iptv-8b60c.firebaseapp.com",
        projectId: "iptv-8b60c",
        storageBucket: "iptv-8b60c.firebasestorage.app",
        messagingSenderId: "259048691910",
        appId: "1:259048691910:web:b57f9eeda5546ce4d8dfc7"
      };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- CLOUD FUNCTION ENDPOINT ---
    const CLOUD_FUNCTIONS_BASE = `https://us-central1-${firebaseConfig.projectId}.cloudfunctions.net`;
    const CLOUD_FUNCTION_URL = CLOUD_FUNCTIONS_BASE+'/footballRequest'; 

    (function() {
        "use strict";

        // --- App State ---
        let currentDate = new Date(); 
        let appConfig = { favourit_teams: [], favourite_leagues: [], theme: 'dark-bleu' }; 
        let globalSettings = null; 
        let liveMatchTimer = null;
        let homePageTimer = null; 
        let homePageLoadAllState = false; 
        let currentUser = null; 

        // --- Storage Service (Firebase) ---
        const Storage = {
            // Get user config from Firestore 'usersSettings/{uid}'
            loadUserConfig: async (uid) => {
                try {
                    const doc = await db.collection('usersSettings').doc(uid).get();
                    if (doc.exists) {
                        return doc.data();
                    }
                    return null; 
                } catch (e) {
                    console.error("Error loading user config:", e);
                    throw e;
                }
            },
            
            // Save user config to Firestore 'usersSettings/{uid}'
            saveUserConfig: async (uid, config) => {
                if (!uid) return;
                try {
                    await db.collection('usersSettings').doc(uid).set(config, { merge: true });
                    appConfig = config; 
                } catch (e) {
                    console.error("Error saving user config:", e);
                }
            },
            
            // Get global app settings from 'usersSettings/global'
            loadGlobalSettings: async () => {
                try {
                    const doc = await db.collection('usersSettings').doc('global').get();
                    if (doc.exists) {
                        return doc.data();
                    }
                    return { allowed_leagues: [] }; 
                } catch (e) {
                    console.error("Error loading global settings:", e);
                    return { allowed_leagues: [] };
                }
            }
        };
        
        // --- Config & Favs Helper ---
        const Config = {
            isFav: (type, id) => {
                if (!appConfig) return false;
                const idNum = Number(id);
                if (type === 'team') {
                    return appConfig.favourit_teams && appConfig.favourit_teams.some(team => team.id === idNum);
                }
                if (type === 'league') {
                    if (idNum === 0) return appConfig.favourit_teams && appConfig.favourit_teams.length > 0;
                    return appConfig.favourite_leagues && appConfig.favourite_leagues.some(league => league.id === idNum);
                }
                return false;
            },
            getAllowedLeagues: () => globalSettings ? globalSettings.allowed_leagues : [],
            
            getTvKeys: () => {
                const defaults = {
                    next_day: "VolumeUp",
                    prev_day: "VolumeDown",
                    live_on: "AudioVolumeMute",
                    live_off: "AudioVolumeUp" 
                };
                if (appConfig && appConfig.tv_remote_keys) {
                    return { ...defaults, ...appConfig.tv_remote_keys };
                }
                return defaults;
            }
        };

        // --- Global TV Remote Handler ---
        function handleTvKeydown(event) {
            if (!appConfig) return;
            const nextDayBtn = document.getElementById('next-day');
            const prevDayBtn = document.getElementById('prev-day');
            const liveToggle = document.getElementById('live-toggle');

            if (!nextDayBtn || !prevDayBtn || !liveToggle) return;

            const keys = Config.getTvKeys();

            switch (event.key) {
                case keys.next_day:
                    event.preventDefault(); 
                    nextDayBtn.click();
                    break;
                case keys.prev_day:
                    event.preventDefault();
                    prevDayBtn.click();
                    break;
                case keys.live_on:
                    event.preventDefault();
                    if (!liveToggle.checked || keys.live_off==keys.live_on) {
                        liveToggle.click();
                    }
                    break;
                case keys.live_off:
                    event.preventDefault();
                    if (liveToggle.checked) {
                        liveToggle.click();
                    }
                    break;
            }
        }

        // --- API Service (Via Firebase Cloud Functions) ---
        async function apiFetch(endpointUrl) {
            const [path, queryString] = endpointUrl.split('?');
            const params = {};
            if (queryString) {
                new URLSearchParams(queryString).forEach((value, key) => {
                    params[key] = value;
                });
            }

            let attempts = 0;
            while (attempts < 3) {
                try {
                    const response = await fetch(CLOUD_FUNCTION_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            endpoint: path,
                            params: params
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 204) return []; 
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    const data = await response.json();
                    
                    if (data.errors && Object.keys(data.errors).length > 0) {
                         if (data.errors.requests || data.errors.endpoint) {
                            console.warn(`API warning for ${endpointUrl}:`, data.errors);
                            return []; 
                        }
                        throw new Error(JSON.stringify(data.errors));
                    }
                    
                    return data.response || []; 

                } catch (error) {
                    console.error(`API fetch error (attempt ${attempts + 1}):`, error);
                    attempts++;
                    if (attempts < 3) {
                        await new Promise(res => setTimeout(res, 1000 * attempts)); 
                    } else {
                        throw error; 
                    }
                }
            }
        }

        // --- UI Rendering Functions ---

        async function playSound(type = "default") {
            if (!globalSettings || !globalSettings.soundMap) return;
            
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            
            const audioContext = new AudioContext();
            const url = globalSettings.soundMap[type.toLowerCase()] || globalSettings.soundMap["default"];
            if (!url) return;

            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.start();
            } catch (error) {
                console.warn(`Failed to play sound:`, error);
            }
        }

        function showLoader(container) {
            container.innerHTML = '<div class="loader">Loading...</div>';
        }

        function showError(container, e) {
            container.innerHTML = `<div class="error-message">Error: ${e.message}</div>`;
            console.log(e)
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        
        function getCurrentSeason() {
            const today = new Date();
            const month = today.getMonth(); 
            return (month < 6) ? today.getFullYear() - 1 : today.getFullYear();
        }

        function renderHeader(container) {
            const displayUser = currentUser ? (currentUser.email || 'User') : 'Guest';
            
            container.innerHTML = `
                <span class="header-username">User: ${displayUser}</span>
                <h1>Lite Football</h1>
                <div class="date-nav">
                    <button id="prev-day" class="styled-button">&lt;</button>
                    <span id="current-date">${formatDate(currentDate)}</span>
                    <button id="next-day" class="styled-button">&gt;</button>
                </div>
                <div class="live-toggle">
                    <label class="switch-toggle">
                       <input type="checkbox" id="live-toggle">
                       <span class="slider"></span>
                    </label>
                    <label for="live-toggle" style="margin-left: 0.5rem;">Live</label>
                </div>
            `;

            document.getElementById('prev-day').addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 1);
                document.getElementById('live-toggle').checked = false;
                homePageLoadAllState = false; // RESET STATE ON CHANGE
                loadHomePageMatches();
            });
            document.getElementById('next-day').addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 1);
                document.getElementById('live-toggle').checked = false;
                homePageLoadAllState = false; // RESET STATE ON CHANGE
                loadHomePageMatches();
            });
            document.getElementById('live-toggle').addEventListener('change', (e) => {
                if (e.target.checked) {
                    currentDate = new Date(); 
                }
                homePageLoadAllState = false; // RESET STATE ON CHANGE
                loadHomePageMatches();
            });
        }
        
        function renderMatchCard(match, isFavSectionMatch = false) {
            const fixture = match.fixture;
            const league = match.league;
            const teams = match.teams;
            const goals = match.goals;
            const status = fixture.status.short;

            const isLive = !['NS', 'FT', 'PST', 'CANC', 'ABD'].includes(status);

            let scoreText;
            let statusText = fixture.status.long;

            if (status === 'NS') {
                scoreText = '-';
                
                // NEW DATE LOGIC
                const matchDate = new Date(fixture.date);
                const now = new Date();
                const isToday = matchDate.getDate() === now.getDate() && 
                                matchDate.getMonth() === now.getMonth() && 
                                matchDate.getFullYear() === now.getFullYear();
                
                const timeStr = matchDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                if (isToday) {
                     statusText = timeStr;
                } else {
                     const dateStr = matchDate.toLocaleDateString([], { day: 'numeric', month: 'numeric' });
                     statusText = `${dateStr} ${timeStr}`;
                }

            } else {
                scoreText = `${goals.home ?? '0'} - ${goals.away ?? '0'}`;
                if (isLive || status === 'HT') {
                     statusText = `${fixture.status.long} ${fixture.status.elapsed ? `(${fixture.status.elapsed}')` : ''}`;
                } else {
                    statusText = fixture.status.long;
                }
            }
            
            const isFavHome = Config.isFav('team', teams.home.id);
            const isFavAway = Config.isFav('team', teams.away.id);

            const leagueHtml = isFavSectionMatch ? `
                <div class="match-league" title="${league.name}">
                    ${league.logo ? `<img src="${league.logo}" alt="">` : ''}
                    <span>${league.name}</span>
                </div>
            ` : '';

            return `
                <a href="#/match/${fixture.id}" class="match-card ${isLive ? 'is-live' : ''}">
                    ${leagueHtml}
                    <div class="match-status ${status === 'NS' ? 'not-started' : ''}">
                        ${statusText}
                    </div>
                    <div class="match-teams">
                        <div class="team">
                            <img src="${teams.home.logo}" alt="${teams.home.name}">
                            <span class="team-name team-link" data-team-id="${teams.home.id}">${teams.home.name}</span>
                            <span class="fav-toggle" data-type="team" data-id="${teams.home.id}">
                                ${isFavHome ? '‚≠ê' : '‚òÜ'}
                            </span>
                        </div>
                        <div class="score-container">${scoreText}</div>
                        <div class="team">
                            <img src="${teams.away.logo}" alt="${teams.away.name}">
                            <span class="team-name team-link" data-team-id="${teams.away.id}">${teams.away.name}</span>
                            <span class="fav-toggle" data-type="team" data-id="${teams.away.id}">
                                ${isFavAway ? '‚≠ê' : '‚òÜ'}
                            </span>
                        </div>
                    </div>
                </a>
            `;
        }
        
        function addCardListeners(container) {
            container.querySelectorAll('.fav-toggle').forEach(toggle => {
                toggle.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    if (!currentUser) {
                        document.getElementById('auth-modal').classList.add('visible');
                        document.getElementById('auth-message').textContent = "Please sign in to save favorites.";
                        return;
                    }

                    const type = e.currentTarget.dataset.type;
                    const id = Number(e.currentTarget.dataset.id);
                    
                    if (!type || !id || !appConfig) return;
                    
                    const newConfig = JSON.parse(JSON.stringify(appConfig));
                    let favArray;

                    if (type === 'team') {
                        if (!newConfig.favourit_teams) newConfig.favourit_teams = [];
                        favArray = newConfig.favourit_teams;
                    } else if (type === 'league') {
                        if (!newConfig.favourite_leagues) newConfig.favourite_leagues = [];
                        favArray = newConfig.favourite_leagues;
                    } else {
                        return;
                    }

                    const index = favArray.findIndex(item => item.id === id);
                    
                    if (index > -1) {
                        favArray.splice(index, 1);
                        e.currentTarget.textContent = '‚òÜ';
                    } else {
                        let name = 'Unknown';
                        
                        if (type === 'team') {
                            let teamNameEl = e.currentTarget.closest('.team-info-details')?.querySelector('h2');
                            if (!teamNameEl) teamNameEl = e.currentTarget.closest('.team-cell')?.querySelector('a');
                            if (!teamNameEl) teamNameEl = e.currentTarget.closest('.team')?.querySelector('.team-name');
                            name = teamNameEl ? teamNameEl.textContent.replace('‚≠ê','').replace('‚òÜ','').trim() : 'Unknown Team';
                        } else if (type === 'league') {
                            if (id === 0) {
                                name = 'Favorites';
                            } else {
                                let leagueNameEl = e.currentTarget.closest('.page-title')?.querySelector('span');
                                if (!leagueNameEl) leagueNameEl = e.currentTarget.closest('.league-header')?.querySelector('.league-header-link span');
                                name = leagueNameEl ? leagueNameEl.textContent : 'Unknown League';
                            }
                        }
                        
                        favArray.push({ id: id, name: name });
                        e.currentTarget.textContent = '‚≠ê';
                    }
                    
                    await Storage.saveUserConfig(currentUser.uid, newConfig);
                });
            });
            
            container.querySelectorAll('.team-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault(); 
                    e.stopPropagation(); 
                    const teamId = e.currentTarget.dataset.teamId;
                    if (teamId) window.location.hash = `#/team/${teamId}`;
                });
            });
        }
        
        // --- Tab Renderers ---
        function renderEvent(event) {
            let icon = '';
            let detail = event.detail;
            if (event.type === 'Goal') icon = '‚öΩ';
            if (event.type === 'subst') icon = 'üîÑ';
            if (event.type === 'Card') icon = event.detail === 'Yellow Card' ? 'üü®' : 'üü•';
            
            return `
                <div class="event-item ${event.team.id === window.currentMatchHomeTeamId ? 'home-event' : 'away-event'}">
                    <div class="event-time">${event.time.elapsed}'</div>
                    <div class="event-icon">${icon}</div>
                    <div class="event-info">
                        <div class="event-player">${event.player.name}</div>
                        <div class="event-detail">${event.assist.name ? `Assist: ${event.assist.name}` : detail}</div>
                    </div>
                </div>
            `;
        }
        
        function renderLineup(lineupData) {
            if (!lineupData || lineupData.length < 2) return '<p>Lineups not available.</p>';
            
            const home = lineupData[0];
            const away = lineupData[1];
            
            const renderPlayerList = (players) => {
                if(!players){
                    return "";
                }
                return players.map(p => `
                    <li>
                        <span class="player-number">${p.player.number}</span>
                        ${p.player.name}
                    </li>
                `).join('');
            };
            
            return `
                <div class="lineup-container">
                    <div class="lineup-team">
                        <h3><img src="${home.team.logo}" alt=""> ${home.team.name}</h3>
                        <div class="lineup-info">Manager: ${home.coach.name || 'N/A'}<br>Formation: ${home.formation || 'N/A'}</div>
                        <div class="lineup-list-title">Starting XI</div>
                        <ul class="lineup-list">${renderPlayerList(home.startXI)}</ul>
                        <div class="lineup-list-title">Substitutes</div>
                        <ul class="lineup-list">${renderPlayerList(home.substitutes)}</ul>
                    </div>
                    <div class="lineup-team">
                        <h3><img src="${away.team.logo}" alt=""> ${away.team.name}</h3>
                        <div class="lineup-info">Manager: ${away.coach.name || 'N/A'}<br>Formation: ${away.formation || 'N/A'}</div>
                        <div class="lineup-list-title">Starting XI</div>
                        <ul class="lineup-list">${renderPlayerList(away.startXI)}</ul>
                        <div class="lineup-list-title">Substitutes</div>
                        <ul class="lineup-list">${renderPlayerList(away.substitutes)}</ul>
                    </div>
                </div>
            `;
        }
        
        function renderStatistics(statsData) {
            if (!statsData || statsData.length < 2) return '<p>Statistics not available.</p>';
            const home = statsData[0];
            const away = statsData[1];
            const statsMap = new Map();
            home.statistics.forEach(stat => statsMap.set(stat.type, { home: stat.value ?? 0 }));
            away.statistics.forEach(stat => {
                const existing = statsMap.get(stat.type) || { home: 0 };
                existing.away = stat.value ?? 0;
                statsMap.set(stat.type, existing);
            });
            let html = `<div class="stats-container">`;
            statsMap.forEach((values, type) => {
                html += `
                    <div class="stat-row">
                        <div class="stat-value">${values.home}</div>
                        <div class="stat-name">${type}</div>
                        <div class="stat-value">${values.away}</div>
                    </div>
                `;
            });
            return html + `</div>`;
        }
        
        function renderH2H(h2hData) {
            if (!h2hData || h2hData.length === 0) return '<p>No head-to-head data available.</p>';
            const homeTeamId = h2hData[0].teams.home.id;
            let homeWins = 0, awayWins = 0, draws = 0;
            h2hData.forEach(match => {
                if (match.fixture.status.short !== 'FT') return; 
                if (match.goals.home === match.goals.away) draws++;
                else if (match.teams.home.id === homeTeamId) match.goals.home > match.goals.away ? homeWins++ : awayWins++;
                else match.goals.home > match.goals.away ? awayWins++ : homeWins++;
            });
            return `
                <div class="h2h-container">
                    <h3>${homeWins} Wins | ${draws} Draws | ${awayWins} Wins</h3>
                    <div class="matches-container">${h2hData.map(match => renderMatchCard(match, true)).join('')}</div>
                </div>
            `;
        }


        // --- Page Controllers ---

        async function renderHomePage(container) {
            const headerContainer = document.getElementById('app-header');
            renderHeader(headerContainer);
            container.innerHTML = '<div class="loader">Loading matches...</div>';
            homePageLoadAllState = false; 
            await loadHomePageMatches(false, false);
        }

        async function loadHomePageMatches(loadAll = false, isRefresh = false) {
            // Check for global settings availability first to ensure filtering works correctly
            if (!globalSettings) {
                try {
                    // We wait for settings here so we know what to filter
                    globalSettings = await Storage.loadGlobalSettings();
                } catch(e) { console.error("Lazy load settings failed", e); }
            }

            if (loadAll) homePageLoadAllState = true;
            const container = document.getElementById('content-container');
            const isLive = document.getElementById('live-toggle') ? document.getElementById('live-toggle').checked : false;
            const date = formatDate(currentDate);
            
            if (document.getElementById('current-date')) document.getElementById('current-date').textContent = date;
            if (!isRefresh) showLoader(container);

            try {
                const allowedLeagues = Config.getAllowedLeagues();
                const allowedLeagueIds = allowedLeagues.map(l => l.id);

                let endpoint = `fixtures?date=${date}&season=${getCurrentSeason()}`;
                if (isLive) endpoint = `fixtures?live=all`;
                
                const matchesResponse = await apiFetch(endpoint);
                
                const favTeamIds = new Set((appConfig.favourit_teams || []).map(team => team.id));
                const favLeagueIds = new Set((appConfig.favourite_leagues || []).map(league => league.id));

                const favTeamMatches = [];
                const favLeagueMatches = [];
                const otherMatches = []; 

                for (const match of matchesResponse) {
                    const leagueId = match.league.id;
                    const isFavTeamMatch = favTeamIds.has(match.teams.home.id) || favTeamIds.has(match.teams.away.id);
                    const isFavLeagueMatch = favLeagueIds.has(leagueId);

                    if (isFavTeamMatch) favTeamMatches.push(match);
                    else if (isFavLeagueMatch) favLeagueMatches.push(match);
                    else otherMatches.push(match);
                }
                
                // RESTORED LOGIC: Show All only if state is true OR if no leagues are allowed/configured
                const showAll = homePageLoadAllState || allowedLeagueIds.length === 0;
                
                const allowedOtherMatches = showAll
                    ? otherMatches 
                    : otherMatches.filter(m => allowedLeagueIds.includes(m.league.id));
                
                const favLeagueGroups = {};
                const otherLeagueGroups = {};

                for (const match of favLeagueMatches) {
                    const id = match.league.id;
                    if (!favLeagueGroups[id]) favLeagueGroups[id] = { name: match.league.name, logo: match.league.logo, matches: [] };
                    favLeagueGroups[id].matches.push(match);
                }

                for (const match of allowedOtherMatches) { 
                    const id = match.league.id;
                    if (!otherLeagueGroups[id]) otherLeagueGroups[id] = { name: match.league.name, logo: match.league.logo, matches: [] };
                    otherLeagueGroups[id].matches.push(match);
                }

                let html = '';
                if (favTeamMatches.length > 0) {
                    html += `
                        <div class="league-group">
                            <div class="league-header">
                                <span>‚≠ê Favorites</span>
                                <span class="fav-toggle" data-type="league" data-id="0">${Config.isFav('league', 0) ? '‚≠ê' : '‚òÜ'}</span>
                            </div>
                            <div class="matches-container">${favTeamMatches.map(match => renderMatchCard(match, true)).join('')}</div>
                        </div>
                    `;
                }

                const renderLeagueGroup = (leagueId, group) => `
                    <div class="league-group">
                        <div class="league-header">
                            <a href="#/league/${leagueId}" class="league-header-link">
                                ${group.logo ? `<img src="${group.logo}" alt="" class="league-header-logo">` : ''}
                                <span>${group.name}</span>
                            </a>
                            <span class="fav-toggle" data-type="league" data-id="${leagueId}">${Config.isFav('league', leagueId) ? '‚≠ê' : '‚òÜ'}</span>
                        </div>
                        <div class="matches-container">${group.matches.map(match => renderMatchCard(match, false)).join('')}</div>
                    </div>
                `;

                for (const leagueId in favLeagueGroups) html += renderLeagueGroup(leagueId, favLeagueGroups[leagueId]);
                for (const leagueId in otherLeagueGroups) html += renderLeagueGroup(leagueId, otherLeagueGroups[leagueId]);
                
                if (html === '') html = '<p>No matches found for this date.</p>';
                
                // RESTORED BUTTON: Only show if we are NOT showing all matches (and there are actually matches to show)
                if (!homePageLoadAllState && allowedLeagueIds.length > 0) {
                     html += `<div style="text-align: center; margin-top: 1.5rem;"><button id="load-all-matches-btn" class="styled-button">Load All Matches</button></div>`;
                }

                container.innerHTML = html;
                addCardListeners(container);
                
                const loadAllBtn = container.querySelector('#load-all-matches-btn');
                if (loadAllBtn) loadAllBtn.addEventListener('click', () => loadHomePageMatches(true, false));

            } catch (error) {
                if (!isRefresh) showError(container, error);
                else console.error("Home page refresh failed:", error);
            }
        }

        async function renderMatchPage(container, id) {
            document.getElementById('app-header').innerHTML = `<h1><a href="#/" style="color:var(--text-primary); text-decoration:none;">Lite Football</a></h1>`;
            showLoader(container);
            
            let lastScore = '';
            let lastEventsCount = 0;
            
            try {
                const matchDataArr = await apiFetch(`fixtures?id=${id}`);
                const matchData = matchDataArr[0];
                if (!matchData) throw new Error("Match not found.");
                
                const { fixture, league, teams, goals } = matchData;
                const { home, away } = teams;
                window.currentMatchHomeTeamId = home.id;

                const isLive = !['NS', 'FT', 'PST', 'CANC', 'ABD'].includes(fixture.status.short);
                const isFinished = ['FT', 'AET', 'PEN', 'PST', 'CANC', 'ABD'].includes(fixture.status.short);
                
                const [events, lineup, statistics, headtohead] = await Promise.all([
                    apiFetch(`fixtures/events?fixture=${id}`),
                    apiFetch(`fixtures/lineups?fixture=${id}`),
                    isFinished ? apiFetch(`fixtures/statistics?fixture=${id}`) : Promise.resolve([]),
                    apiFetch(`fixtures/headtohead?h2h=${home.id}-${away.id}`)
                ]);

                lastScore = `${goals.home ?? '0'} - ${goals.away ?? '0'}`;
                lastEventsCount = events.length;

                let tabsHtml = '<div class="tabs">';
                let tabContentsHtml = '';
                
                const addTab = (id, name, active = false, content) => {
                    tabsHtml += `<button class="tab-button ${active ? 'active' : ''}" data-tab="${id}">${name}</button>`;
                    tabContentsHtml += `<div id="${id}" class="tab-content ${active ? 'active' : ''}">${content}</div>`;
                };

                if (isLive) {
                    addTab('events', 'Events', true, `<div class="match-events">${events.map(renderEvent).join('')}</div>`);
                    addTab('lineup', 'Lineup', false, renderLineup(lineup));
                    addTab('h2h', 'Head to Head', false, renderH2H(headtohead));
                } else if (isFinished) {
                    addTab('stats', 'Stats', true, renderStatistics(statistics));
                    addTab('events', 'Events', false, `<div class="match-events">${events.map(renderEvent).join('')}</div>`);
                    addTab('lineup', 'Lineup', false, renderLineup(lineup));
                    addTab('h2h', 'Head to Head', false, renderH2H(headtohead));
                } else {
                    addTab('lineup', 'Lineup', true, renderLineup(lineup));
                    addTab('h2h', 'Head to Head', false, renderH2H(headtohead));
                }
                tabsHtml += '</div>';

                container.innerHTML = `
                    <h2 class="page-title"><span><a href="#/">Home</a> &gt; Match Details</span></h2>
                    ${isLive ? `<div class="live-track-controls"><label class="switch-toggle"><input type="checkbox" id="live-sound-checkbox"><span class="slider"></span></label><label style="margin-left: 0.5rem;">Sound on change</label></div>` : ''}
                    <div class="match-details-header">
                        <div class="league"><a href="#/league/${league.id}">${league.name}</a> - ${league.round}</div>
                        <div class="match-details-teams">
                            <div class="match-details-team"><a href="#/team/${home.id}"><img src="${home.logo}" alt=""><h2>${home.name}</h2></a></div>
                            <div class="match-details-score">${goals.home ?? '0'} - ${goals.away ?? '0'}</div>
                            <div class="match-details-team"><a href="#/team/${away.id}"><img src="${away.logo}" alt=""><h2>${away.name}</h2></a></div>
                        </div>
                        <div class="match-details-status">${fixture.status.long} ${fixture.status.elapsed ? `(${fixture.status.elapsed}')` : ''}</div>
                    </div>
                    ${tabsHtml}
                    ${tabContentsHtml}
                `;
                
                container.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', () => {
                        container.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                        container.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                        button.classList.add('active');
                        container.querySelector(`#${button.dataset.tab}`).classList.add('active');
                    });
                });
                
                if (isLive) {
                    if (liveMatchTimer) clearInterval(liveMatchTimer);
                    liveMatchTimer = setInterval(async () => {
                        try {
                            const [refreshedMatchDataArr, refreshedEvents, refreshedLineup] = await Promise.all([
                                apiFetch(`fixtures?id=${id}`),
                                apiFetch(`fixtures/events?fixture=${id}`),
                                apiFetch(`fixtures/lineups?fixture=${id}`)
                            ]);
                            
                            const rFix = refreshedMatchDataArr[0].fixture;
                            const rGoals = refreshedMatchDataArr[0].goals;
                            const rIsLive = !['NS', 'FT', 'PST', 'CANC', 'ABD'].includes(rFix.status.short);

                            if (!rIsLive) {
                                clearInterval(liveMatchTimer);
                                window.location.reload(); 
                                return;
                            }
                            
                            const newScore = `${rGoals.home ?? '0'} - ${rGoals.away ?? '0'}`;
                            const changed = (newScore !== lastScore || refreshedEvents.length !== lastEventsCount);
                            
                            if (changed) {
                                lastScore = newScore;
                                lastEventsCount = refreshedEvents.length;
                                if (document.getElementById('live-sound-checkbox')?.checked) playSound();
                            }

                            document.querySelector('.match-details-score').textContent = newScore;
                            document.querySelector('.match-details-status').textContent = `${rFix.status.long} ${rFix.status.elapsed ? `(${rFix.status.elapsed}')` : ''}`;
                            
                            const eventsTab = document.getElementById('events');
                            if (eventsTab) eventsTab.innerHTML = `<div class="match-events">${refreshedEvents.map(renderEvent).join('')}</div>`;
                            
                            const lineupTab = document.getElementById('lineup');
                            if (lineupTab) lineupTab.innerHTML = renderLineup(refreshedLineup);

                        } catch (err) { console.error("Error during live refresh:", err); }
                    }, 60000);
                }
            } catch (error) { showError(container, error); }
        }

        async function renderLeaguePage(container, id) {
            document.getElementById('app-header').innerHTML = `<h1><a href="#/" style="color:var(--text-primary); text-decoration:none;">Lite Football</a></h1>`;
            showLoader(container);
            
            try {
                const season = getCurrentSeason();
                // Fetch Standings, Scorers, Assists AND Fixtures
                const [standingsResponse, scorersData, assistsData, fixturesData] = await Promise.all([
                    apiFetch(`standings?league=${id}&season=${season}`),
                    apiFetch(`players/topscorers?league=${id}&season=${season}`),
                    apiFetch(`players/topassists?league=${id}&season=${season}`),
                    apiFetch(`fixtures?league=${id}&season=${season}`)
                ]);

                const leagueInfo = standingsResponse[0]?.league || 
                                 (scorersData[0] ? scorersData[0].statistics[0].league : null) ||
                                 (assistsData[0] ? assistsData[0].statistics[0].league : null) ||
                                 (fixturesData[0] ? fixturesData[0].league : null);
                
                if (!leagueInfo) throw new Error("League data not found.");
                
                const standings = standingsResponse[0]?.league.standings || [];
                const isFav = Config.isFav('league', leagueInfo.id);

                container.innerHTML = `
                    <h2 class="page-title">
                        <span><a href="#/">Home</a> &gt; ${leagueInfo.name}</span>
                        <span class="fav-toggle" data-type="league" data-id="${leagueInfo.id}">${isFav ? '‚≠ê' : '‚òÜ'}</span>
                    </h2>
                    <div class="tabs">
                        <button class="tab-button" data-tab="matches">Matches</button>
                        <button class="tab-button active" data-tab="standings">Standings</button>
                        <button class="tab-button" data-tab="scorers">Top Scorers</button>
                        <button class="tab-button" data-tab="assists">Top Assists</button>
                    </div>
                    <div id="matches" class="tab-content">
                        <div class="filters-container">
                            <select id="phase-filter" class="filter-select"><option value="all">All Phases</option></select>
                            <select id="round-filter" class="filter-select"><option value="all">All Rounds</option></select>
                        </div>
                        <div id="matches-list" class="matches-container"></div>
                    </div>
                    <div id="standings" class="tab-content active"></div>
                    <div id="scorers" class="tab-content"></div>
                    <div id="assists" class="tab-content"></div>
                `;
                
                // --- Matches Tab Logic ---
                const matchesContainer = container.querySelector('#matches-list');
                const phaseFilter = container.querySelector('#phase-filter');
                const roundFilter = container.querySelector('#round-filter');
                
                if (fixturesData.length === 0) {
                    matchesContainer.innerHTML = '<p>No matches available.</p>';
                } else {
                    // Extract Phases and Rounds
                    const roundsSet = new Set();
                    const phasesSet = new Set();
                    const roundToPhaseMap = {};
                    
                    fixturesData.sort((a, b) => new Date(a.fixture.date) - new Date(b.fixture.date));

                    // Find "Current" Round (Closest date to today)
                    const today = new Date();
                    let closestMatch = null;
                    let minDiff = Infinity;
                    
                    fixturesData.forEach(m => {
                        const round = m.league.round;
                        roundsSet.add(round);
                        
                        // Heuristic: Extract Phase (e.g. "Regular Season - 1" -> "Regular Season")
                        let phase = round;
                        if (round.includes(" - ")) {
                            phase = round.split(" - ")[0];
                        } else if (round.includes("Group Stage")) {
                            phase = "Group Stage";
                        }
                        
                        phasesSet.add(phase);
                        roundToPhaseMap[round] = phase;

                        // Calculate diff for current round
                        const diff = Math.abs(new Date(m.fixture.date) - today);
                        if (diff < minDiff) {
                            minDiff = diff;
                            closestMatch = m;
                        }
                    });
                    
                    const currentRound = closestMatch ? closestMatch.league.round : null;
                    const currentPhase = currentRound ? roundToPhaseMap[currentRound] : null;

                    // Populate Filters
                    phasesSet.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p;
                        opt.textContent = p + (p === currentPhase ? ' (Current)' : '');
                        phaseFilter.appendChild(opt);
                    });
                    
                    // Helper to populate rounds based on phase
                    const populateRounds = (selectedPhase) => {
                        roundFilter.innerHTML = '<option value="all">All Rounds</option>';
                        roundsSet.forEach(r => {
                            if (selectedPhase === 'all' || roundToPhaseMap[r] === selectedPhase) {
                                const opt = document.createElement('option');
                                opt.value = r;
                                opt.textContent = r + (r === currentRound ? ' (Current)' : '');
                                roundFilter.appendChild(opt);
                            }
                        });
                    };
                    
                    // Set Defaults
                    if (currentPhase) {
                        phaseFilter.value = currentPhase;
                        populateRounds(currentPhase);
                    } else {
                        populateRounds('all');
                    }
                    if (currentRound) roundFilter.value = currentRound;

                    const renderFilteredMatches = () => {
                        const pVal = phaseFilter.value;
                        const rVal = roundFilter.value;
                        
                        const filtered = fixturesData.filter(m => {
                            const mPhase = roundToPhaseMap[m.league.round];
                            const mRound = m.league.round;
                            
                            const phaseMatch = (pVal === 'all' || mPhase === pVal);
                            const roundMatch = (rVal === 'all' || mRound === rVal);
                            
                            return phaseMatch && roundMatch;
                        });
                        
                        if (filtered.length === 0) {
                            matchesContainer.innerHTML = '<p>No matches found for selection.</p>';
                        } else {
                            matchesContainer.innerHTML = filtered.map(m => renderMatchCard(m, false)).join('');
                        }
                        addCardListeners(matchesContainer);
                    };
                    
                    // Event Listeners
                    phaseFilter.addEventListener('change', () => {
                        populateRounds(phaseFilter.value);
                        renderFilteredMatches();
                    });
                    roundFilter.addEventListener('change', renderFilteredMatches);
                    
                    // Initial Render
                    renderFilteredMatches();
                }

                // --- Standings Logic ---
                let standingsHtml = '';
                if (standings.length === 0) standingsHtml = '<p>Standings not available.</p>';
                else {
                    for (const group of standings) {
                        if (standings.length > 1) standingsHtml += `<h3 class="group-title">${group[0].group}</h3>`;
                        standingsHtml += `
                            <table class="standings-table">
                                <thead><tr><th>#</th><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead>
                                <tbody>
                                    ${group.map(team => `
                                        <tr>
                                            <td class="rank">${team.rank}</td>
                                            <td class="team-cell"><img src="${team.team.logo}"><a href="#/team/${team.team.id}">${team.team.name}</a></td>
                                            <td>${team.all.played}</td><td>${team.all.win}</td><td>${team.all.draw}</td><td>${team.all.lose}</td>
                                            <td>${team.goalsDiff}</td><td><strong>${team.points}</strong></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                }
                container.querySelector('#standings').innerHTML = standingsHtml;
                
                const renderStatsList = (data) => {
                    if (data.length === 0) return '<p>Data not available.</p>';
                    return `<div class="stats-list">${data.map((item, index) => `
                        <div class="stat-item">
                            <div class="rank">${index + 1}</div><img src="${item.player.photo}">
                            <div class="stat-item-info"><div class="stat-item-player">${item.player.name}</div><div class="stat-item-team">${item.statistics[0].team.name}</div></div>
                            <div class="stat-item-value">${item.statistics[0].goals.total || item.statistics[0].goals.assists}</div>
                        </div>`).join('')}</div>`;
                };
                
                container.querySelector('#scorers').innerHTML = renderStatsList(scorersData);
                container.querySelector('#assists').innerHTML = renderStatsList(assistsData);
                
                container.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', () => {
                        container.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                        container.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                        button.classList.add('active');
                        container.querySelector(`#${button.dataset.tab}`).classList.add('active');
                    });
                });
                addCardListeners(container);
            } catch (error) { showError(container, error); }
        }

        async function renderTeamPage(container, id) {
            document.getElementById('app-header').innerHTML = `<h1><a href="#/" style="color:var(--text-primary); text-decoration:none;">Lite Football</a></h1>`;
            showLoader(container);
            try {
                const teamDataArr = await apiFetch(`teams?id=${id}`);
                const teamData = teamDataArr[0];
                if (!teamData) throw new Error("Team not found.");

                const { team, venue } = teamData;
                const isFav = Config.isFav('team', team.id);

                container.innerHTML = `
                    <h2 class="page-title"><span><a href="#/">Home</a> &gt; Team</span></h2>
                    <div class="team-info-header">
                        <img src="${team.logo}" alt="${team.name}">
                        <div class="team-info-details">
                            <h2>${team.name} <span class="fav-toggle" data-type="team" data-id="${team.id}">${isFav ? '‚≠ê' : '‚òÜ'}</span></h2>
                            <p>${team.country} | Founded: ${team.founded}</p>
                            <p>${venue.name}, ${venue.city} (Capacity: ${venue.capacity})</p>
                        </div>
                    </div>
                `;
                addCardListeners(container);
            } catch (error) { showError(container, error); }
        }

        function AppRouter() {
            if (liveMatchTimer) clearInterval(liveMatchTimer);
            if (homePageTimer) clearInterval(homePageTimer);
            
            const path = window.location.hash.substring(1) || '/';
            const mainContainer = document.getElementById('content-container');
            document.getElementById('app-header').innerHTML = '';
            showLoader(mainContainer);
            delete window.currentMatchHomeTeamId;

            if (path.startsWith('/match/')) renderMatchPage(mainContainer, path.split('/')[2]);
            else if (path.startsWith('/league/')) renderLeaguePage(mainContainer, path.split('/')[2]);
            else if (path.startsWith('/team/')) renderTeamPage(mainContainer, path.split('/')[2]);
            else {
                renderHomePage(mainContainer);
                homePageTimer = setInterval(() => loadHomePageMatches(homePageLoadAllState, true), 60000);
            }
        }
        
        function applyTheme(theme) {
            const validThemes = ['dark-bleu', 'dark-red', 'darky-dark', 'light', 'morocco', 'morocco-away', 'usk', 'raja'];
            const themeToApply = validThemes.includes(theme) ? theme : 'dark-bleu';
            document.body.className = ''; 
            if (themeToApply !== 'dark-bleu') document.body.classList.add(`theme-${themeToApply}`);
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) themeSelect.value = themeToApply;
        }
        
        // --- Initialization ---
        function init() {
            document.addEventListener('keydown', handleTvKeydown);
            
            // 1. Start App Immediately (Fixes slow F5)
            // We run AppRouter immediately to show the loader and start fetching API data.
            // We do NOT wait for Auth or Global Settings here.
            AppRouter();

            // 2. Load Global Settings in background
            Storage.loadGlobalSettings().then(settings => {
                globalSettings = settings;
                // If on homepage, we might want to refresh to apply allowed_leagues if needed,
                // but usually the default 'show all' is fine for the first second.
            });
            
            // 3. UI Elements Setup
            const modal = document.getElementById('auth-modal');
            const authError = document.getElementById('auth-error');
            const authTitle = document.getElementById('auth-title');
            const authMessage = document.getElementById('auth-message');
            const btnLogin = document.getElementById('btn-login');
            const btnSignup = document.getElementById('btn-signup');
            const toggleLink = document.getElementById('auth-toggle-link');
            const toggleText = document.getElementById('auth-toggle-text');
            const btnAuthAction = document.getElementById('btn-auth-action');
            const btnModalClose = document.getElementById('modal-close-btn');
            let isLoginMode = true;
            
            btnModalClose.addEventListener('click', () => { modal.classList.remove('visible'); });
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('visible'); });

            // 4. Auth State Listener
            // This runs in parallel. When it finishes (after ~1-2s), it updates the UI.
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    modal.classList.remove('visible');
                    btnAuthAction.textContent = "Logout";
                    
                    const savedConfig = await Storage.loadUserConfig(user.uid);
                    if (savedConfig) appConfig = savedConfig;
                    else await Storage.saveUserConfig(user.uid, appConfig);
                    
                    applyTheme(appConfig.theme);
                    // Optional: Re-run router if you want to ensure favs are marked immediately,
                    // but it might reload the page content. 
                    // For now, we just let the next interaction pick up the config.
                } else {
                    currentUser = null;
                    appConfig = { favourit_teams: [], favourite_leagues: [], theme: 'dark-bleu' };
                    modal.classList.remove('visible');
                    btnAuthAction.textContent = "Login";
                    applyTheme('dark-bleu');
                }
            });

            // Toggle Login/Signup
            toggleLink.addEventListener('click', (e) => {
                e.preventDefault();
                isLoginMode = !isLoginMode;
                authError.textContent = '';
                
                if (isLoginMode) {
                    authTitle.textContent = "Sign In";
                    authMessage.textContent = "Please sign in to load your Firebase settings.";
                    btnLogin.style.display = 'block';
                    btnSignup.style.display = 'none';
                    toggleText.textContent = "Don't have an account?";
                    toggleLink.textContent = "Sign Up";
                } else {
                    authTitle.textContent = "Register";
                    authMessage.textContent = "Create an account to save your favorites.";
                    btnLogin.style.display = 'none';
                    btnSignup.style.display = 'block';
                    toggleText.textContent = "Already have an account?";
                    toggleLink.textContent = "Sign In";
                }
            });

            // Login Action
            btnLogin.addEventListener('click', async () => {
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    authError.textContent = error.message;
                }
            });

            // Signup Action
            btnSignup.addEventListener('click', async () => {
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                try {
                    await auth.createUserWithEmailAndPassword(email, password);
                } catch (error) {
                    authError.textContent = error.message;
                }
            });

            // Login/Logout Action (Footer Button)
            btnAuthAction.addEventListener('click', () => {
                if (currentUser) {
                    auth.signOut();
                } else {
                    modal.classList.add('visible');
                    document.getElementById('auth-message').textContent = "Please sign in to load your Firebase settings.";
                }
            });
            
            // Theme Select Listener
            document.getElementById('theme-select').addEventListener('change', (e) => {
                const newTheme = e.target.value;
                if (appConfig) { 
                    appConfig.theme = newTheme;
                    if (currentUser) {
                        Storage.saveUserConfig(currentUser.uid, appConfig);
                    }
                }
                applyTheme(newTheme);
            });
        }

        document.addEventListener('DOMContentLoaded', init);
        window.addEventListener('hashchange', AppRouter);

    })();
</script>
</body>
</html>